<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>POLNET v11.0 - Emniyet Bilgi Sistemi</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://meet.jit.si/external_api.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg-color: #0f172a; --text-color: #e2e8f0; --sidebar-bg: #020617; --card-bg: #1e293b; --accent: #3b82f6; --danger: #ef4444; --success: #10b981; --warning: #f59e0b; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; }
        
        /* Layout */
        .sidebar { width: 280px; background: var(--sidebar-bg); padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #334155; overflow-y: auto; }
        .content { flex: 1; padding: 30px; overflow-y: auto; position: relative; background-image: radial-gradient(#1e293b 1px, transparent 1px); background-size: 20px 20px; }
        
        /* UI Elements */
        .menu-item { padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 6px; display: flex; align-items: center; gap: 10px; transition: 0.2s; font-size: 0.9rem; color: #94a3b8; }
        .menu-item:hover, .active-tab { background: rgba(59, 130, 246, 0.1); color: white; border-left: 3px solid var(--accent); }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.8rem; color: white; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-blue { background: var(--accent); } .btn-red { background: var(--danger); } .btn-green { background: var(--success); } .btn-dark { background: #334155; }
        .search-box, select, textarea { width: 100%; padding: 10px; margin-bottom: 10px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 4px; box-sizing: border-box; }
        
        /* Tables & Cards */
        table { width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 8px; overflow: hidden; margin-bottom: 20px; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #334155; }
        th { background: #0f172a; color: #94a3b8; font-weight: 600; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 8px; border: 1px solid #334155; margin-bottom: 20px; }
        
        /* Modals */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); width: 60%; margin: 5% auto; border-radius: 10px; overflow: hidden; border: 1px solid #334155; display: flex; flex-direction: column; max-height: 85vh; }
        .modal-header { padding: 15px 20px; background: #0f172a; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; }

        /* Custom Badges */
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .badge-red { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; }
        .badge-green { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid #10b981; }
        .badge-yellow { background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid #f59e0b; }

        /* Image Upload Preview */
        .img-preview { width: 100px; height: 100px; border: 2px dashed #444; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-top: 5px; cursor: pointer; }
        .img-preview img { width: 100%; height: 100%; object-fit: cover; }

        /* Login */
        #loginScreen { position: fixed; top:0; left:0; width:100%; height:100%; background: #020617; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        
        .tab-content { display: none; } .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="loginScreen">
    <div style="background: #1e293b; padding: 40px; border-radius: 12px; width: 350px; text-align: center; border: 1px solid #334155;">
        <img src="egmm.png" style="width:80px; margin-bottom:15px;">
        <h2 style="margin:0 0 5px 0;">POLNET v11</h2>
        <p style="color:#64748b; margin-bottom:20px;">Emniyet Bilgi Sistemi</p>
        <input type="text" id="kadi" class="search-box" placeholder="Sicil No / Kullanıcı Adı">
        <input type="password" id="sifre" class="search-box" placeholder="Şifre">
        <button onclick="girisYap()" class="btn btn-blue" style="width:100%; justify-content:center; padding:12px;">SİSTEME GİRİŞ</button>
        <p id="loginMsg" style="color:var(--danger); margin-top:10px; font-size:0.9rem;"></p>
    </div>
</div>

<div id="adminPanel" style="display:none; width:100%;">
    <div class="sidebar">
        <div style="text-align:center; margin-bottom:30px; padding-bottom:20px; border-bottom:1px solid #334155;">
            <img src="egmm.png" style="width:60px;">
            <h3 style="margin:10px 0 5px 0;">POLNET</h3>
            <div id="aktifKullaniciAdi" style="font-weight:bold; color:white;"></div>
            <div id="aktifRutbeGoster" class="badge badge-blue" style="display:inline-block; margin-top:5px;"></div>
        </div>

        <div class="menu-item active-tab" onclick="tabDegistir('dashboardTab', this)"><i class="fas fa-chart-pie"></i> Özet Durum</div>
        <div class="menu-item" onclick="tabDegistir('gbtTab', this)"><i class="fas fa-fingerprint"></i> GBT & Kimlik</div>
        <div class="menu-item" onclick="tabDegistir('aracTab', this)"><i class="fas fa-car"></i> Araç & Trafik</div>
        <div class="menu-item" onclick="tabDegistir('tutanakTab', this)"><i class="fas fa-file-contract"></i> Olay Tutanakları</div>
        <div class="menu-item" onclick="tabDegistir('delilTab', this)"><i class="fas fa-folder-open"></i> Delil & Kanıt</div>
        <div class="menu-item" onclick="tabDegistir('ruhsatTab', this)"><i class="fas fa-id-card"></i> Ruhsat İşlemleri</div>
        <div class="menu-item" onclick="tabDegistir('cezaRehberTab', this)"><i class="fas fa-book"></i> TCK & Ceza Rehberi</div>
        <div class="menu-item" onclick="tabDegistir('logTab', this)"><i class="fas fa-history"></i> İşlem Kayıtları</div>
        <div class="menu-item" onclick="tabDegistir('personelTab', this)"><i class="fas fa-users-cog"></i> Personel Yönetimi</div>
        
        <div style="margin-top:auto;">
            <button onclick="location.reload()" class="btn btn-red" style="width:100%; justify-content:center;">GÜVENLİ ÇIKIŞ</button>
        </div>
    </div>

    <div class="content">
        <div id="dashboardTab" class="tab-content active">
            <h2>Komuta Merkezi</h2>
            <div style="display:flex; gap:20px; margin-bottom:20px;">
                <div class="card" style="flex:1; border-left:4px solid var(--accent);"><h3>Aranan Şahıs</h3><h1 id="statAranan">0</h1></div>
                <div class="card" style="flex:1; border-left:4px solid var(--danger);"><h3>Çalıntı Araç</h3><h1 id="statArac">0</h1></div>
                <div class="card" style="flex:1; border-left:4px solid var(--warning);"><h3>Açık Dosya</h3><h1 id="statDosya">0</h1></div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-calculator"></i> Hızlı Ceza Hesapla</h3>
                <button onclick="cezaModalAc()" class="btn btn-blue" style="width:100%; padding:15px;">CEZA SİHİRBAZINI AÇ</button>
            </div>
        </div>

        <div id="gbtTab" class="tab-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>GBT Sorgulama</h2>
                <button onclick="modalAc('gbtEkleModal')" class="btn btn-blue">+ Vatandaş Kaydı Oluştur</button>
            </div>
            <div class="card">
                <input type="text" id="gbtInput" class="search-box" placeholder="TC Kimlik No veya İsim Soyisim..." style="font-size:1.2rem;">
                <button onclick="gbtSorgula()" class="btn btn-green" style="width:100%;">SORGULA</button>
            </div>
            <div id="gbtSonuc"></div>
        </div>

        <div id="aracTab" class="tab-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2>Araç & Trafik Yönetimi</h2>
                <button onclick="modalAc('aracEkleModal')" class="btn btn-blue">+ Araç Kaydı</button>
            </div>
            <div class="card" style="text-align:center;">
                <input type="text" id="plakaInput" class="search-box" placeholder="PLAKA (34 TR 34)" style="text-align:center; font-size:1.5rem; text-transform:uppercase; font-family:monospace;">
                <button onclick="plakaSorgula()" class="btn btn-green">PLAKA SORGULA</button>
            </div>
            <div id="aracSonuc"></div>
        </div>

        <div id="tutanakTab" class="tab-content">
            <div style="display:flex; justify-content:space-between;"><h2>Olay Tutanakları</h2><button onclick="modalAc('tutanakEkleModal')" class="btn btn-blue">+ Tutanak Yaz</button></div>
            <input type="text" id="tutanakAra" class="search-box" placeholder="Olay No veya İçerik Ara..." onkeyup="tabloAra('tutanakAra','tutanakListesi')">
            <table><thead><tr><th>Olay No</th><th>Tarih</th><th>Konu</th><th>Memur</th><th>İşlem</th></tr></thead><tbody id="tutanakListesi"></tbody></table>
        </div>

        <div id="delilTab" class="tab-content">
            <div style="display:flex; justify-content:space-between;"><h2>Delil & Kanıt Odası</h2><button onclick="modalAc('delilEkleModal')" class="btn btn-blue">+ Dosya Aç</button></div>
            <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:20px; margin-top:20px;" id="delilGrid"></div>
        </div>

        <div id="cezaRehberTab" class="tab-content">
            <div style="display:flex; justify-content:space-between;"><h2>TCK Ceza Rehberi</h2><button onclick="tckDuzenle()" id="tckEditBtn" class="btn btn-red" style="display:none;">Düzenle</button></div>
            <input type="text" id="tckAra" class="search-box" placeholder="Suç ara..." onkeyup="tabloAra('tckAra','tckListesi')">
            <div style="height:600px; overflow-y:auto;">
                <table><thead><tr><th>Suç</th><th>Para Cezası</th><th>Hapis/Kamu</th><th>İşlem</th></tr></thead><tbody id="tckListesi"></tbody></table>
            </div>
        </div>

        <div id="ruhsatTab" class="tab-content">
            <div style="display:flex; justify-content:space-between;"><h2>Ruhsat İşlemleri</h2><button onclick="modalAc('ruhsatEkleModal')" class="btn btn-blue">+ Ruhsat Ver</button></div>
            <input type="text" id="ruhsatAra" class="search-box" placeholder="Ara..." onkeyup="tabloAra('ruhsatAra','ruhsatListesi')">
            <table><thead><tr><th>Sahip</th><th>Tip</th><th>Geçerlilik</th><th>Veren</th><th>Durum</th><th>İşlem</th></tr></thead><tbody id="ruhsatListesi"></tbody></table>
        </div>

        <div id="logTab" class="tab-content">
            <h2>Sistem Kayıtları</h2>
            <table><thead><tr><th>Zaman</th><th>Personel</th><th>İşlem</th><th>Detay</th></tr></thead><tbody id="logListesi"></tbody></table>
        </div>

        <div id="personelTab" class="tab-content">
            <h2>Personel Yönetimi</h2>
            <div class="card">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="yeniKadi" placeholder="Sicil / Kullanıcı Adı">
                    <input type="text" id="yeniSifre" placeholder="Şifre">
                    <select id="yeniRutbe">
                        <option value="Memur">Memur</option>
                        <option value="Başpolis">Başpolis</option>
                        <option value="Kıdemli Başpolis">Kıdemli Başpolis</option>
                        <option value="Komiser Yardımcısı">Komiser Yrd.</option>
                        <option value="Komiser">Komiser</option>
                        <option value="Başkomiser">Başkomiser</option>
                        <option value="Emniyet Amiri">Emniyet Amiri</option>
                        <option value="4. Sınıf Emniyet Müdürü">4. Sınıf Emniyet Müdürü</option>
                        <option value="3. Sınıf Emniyet Müdürü">3. Sınıf Emniyet Müdürü</option>
                        <option value="2. Sınıf Emniyet Müdürü">2. Sınıf Emniyet Müdürü</option>
                        <option value="1. Sınıf Emniyet Müdürü">1. Sınıf Emniyet Müdürü</option>
                    </select>
                    <button onclick="personelEkle()" class="btn btn-green">KAYDET</button>
                </div>
            </div>
            <table><thead><tr><th>Sicil</th><th>Rütbe</th><th>İşlem</th></tr></thead><tbody id="personelListesi"></tbody></table>
        </div>
    </div>
</div>

<div id="gbtEkleModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Vatandaş Kaydı</h3><span onclick="modalKapat()" style="cursor:pointer;">X</span></div><div class="modal-body">
    <input id="gbt_isim" class="search-box" placeholder="Ad Soyad">
    <input id="gbt_tc" class="search-box" placeholder="TC Kimlik No">
    <input id="gbt_dogum" class="search-box" placeholder="Doğum Tarihi">
    <textarea id="gbt_not" class="search-box" placeholder="Notlar..."></textarea>
    <button onclick="gbtKaydet()" class="btn btn-green" style="width:100%">KAYDET</button>
</div></div></div>

<div id="aracEkleModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Araç Kaydı</h3><span onclick="modalKapat()" style="cursor:pointer;">X</span></div><div class="modal-body">
    <input id="arac_plaka" class="search-box" placeholder="Plaka" style="text-transform:uppercase;">
    <input id="arac_sahip" class="search-box" placeholder="Sahip">
    <input id="arac_model" class="search-box" placeholder="Marka / Model">
    <select id="arac_durum" class="search-box">
        <option value="Temiz">Temiz</option>
        <option value="Aranıyor">Aranıyor</option>
        <option value="Çalıntı">Çalıntı</option>
        <option value="Bağlandı">Bağlandı (Yediemin)</option>
        <option value="Suça Karışmış">Suça Karışmış</option>
    </select>
    <button onclick="aracKaydet()" class="btn btn-green" style="width:100%">KAYDET</button>
</div></div></div>

<div id="tutanakEkleModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Olay Tutanağı</h3><span onclick="modalKapat()" style="cursor:pointer;">X</span></div><div class="modal-body">
    <div style="display:flex; gap:10px;">
        <input id="tut_no" class="search-box" placeholder="Olay No (Otomatik)" readonly>
        <input id="tut_tarih" class="search-box" type="datetime-local">
    </div>
    <input id="tut_konu" class="search-box" placeholder="Olay Konusu">
    <textarea id="tut_detay" class="search-box" style="height:200px;" placeholder="Olayın detaylı anlatımı..."></textarea>
    <input id="tut_sahislar" class="search-box" placeholder="Karışan Şahıslar">
    <button onclick="tutanakKaydet()" class="btn btn-blue" style="width:100%">OLUŞTUR VE İMZALA</button>
</div></div></div>

<div id="delilEkleModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Kanıt Dosyası</h3><span onclick="modalKapat()" style="cursor:pointer;">X</span></div><div class="modal-body">
    <input id="delil_olay" class="search-box" placeholder="İlgili Olay No">
    <input id="delil_supheli" class="search-box" placeholder="Şüpheli">
    <label style="color:#aaa; font-size:0.8rem;">Bilgisayardan Fotoğraf Seç:</label>
    <input type="file" id="delil_file" class="search-box" accept="image/*" onchange="resimOnizle(this)">
    <div id="previewArea" class="img-preview" style="display:none;"><img id="imgPreview"></div>
    <textarea id="delil_aciklama" class="search-box" style="height:100px; margin-top:10px;" placeholder="Kanıt açıklaması..."></textarea>
    <button onclick="delilKaydet()" class="btn btn-green" style="width:100%">DOSYAYA EKLE</button>
</div></div></div>

<div id="ruhsatEkleModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Ruhsat Düzenle</h3><span onclick="modalKapat()" style="cursor:pointer;">X</span></div><div class="modal-body">
    <input id="ruh_sahip" class="search-box" placeholder="Ad Soyad">
    <select id="ruh_tip" class="search-box">
        <option>Silah Taşıma</option>
        <option>Silah Bulundurma</option>
        <option>Avcılık</option>
        <option>Sürücü Belgesi (B)</option>
        <option>Sürücü Belgesi (A)</option>
    </select>
    <label>Geçerlilik Tarihi:</label>
    <input type="date" id="ruh_tarih" class="search-box">
    <button onclick="ruhsatKaydet()" class="btn btn-green" style="width:100%">ONAYLA VE VER</button>
</div></div></div>

<div id="cezaModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Ceza Hesaplama</h3><span onclick="modalKapat()" style="cursor:pointer;">X</span></div><div class="modal-body">
    <input id="ceza_sahis" class="search-box" placeholder="Ceza Kesilecek Kişi..." style="border:2px solid var(--danger);">
    <div style="display:flex; gap:10px; margin-bottom:10px;">
        <input id="ceza_ara" class="search-box" placeholder="Suç ara..." onkeyup="cezaFiltrele()">
        <button onclick="cezaSifirla()" class="btn btn-dark">Temizle</button>
    </div>
    <div id="cezaSecimListesi" style="height:300px; overflow-y:auto; border:1px solid #334155; padding:10px; display:grid; grid-template-columns:1fr 1fr; gap:5px;"></div>
    <div style="background:#0f172a; padding:15px; text-align:center; margin-top:10px; border-radius:8px;">
        <h2 id="toplamTutar" style="color:var(--danger); margin:0;">0 TL / 0 Ay</h2>
        <small>Toplam Ceza</small>
    </div>
    <button onclick="cezayiKes()" class="btn btn-red" style="width:100%; margin-top:10px; padding:15px;">İŞLEMİ UYGULA</button>
</div></div></div>

<div id="tutanakOkuModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Tutanak Detayı</h3><span onclick="modalKapat()" style="cursor:pointer;">X</span></div><div class="modal-body" id="tutanakOkuIcerik"></div></div></div>

<script src="config.js"></script>
<script>
    // --- GÜÇLENDİRİLMİŞ TCK LİSTESİ (100+ ÖĞE İÇİN ÖRNEK) ---
    // Gerçek bir senaryoda bu liste JSON dosyasından çekilebilir.
    let tckListesi = [
        {ad:"Hız Sınırı İhlali", p:2500, h:0, kat:"Trafik"},
        {ad:"Kırmızı Işık İhlali", p:1500, h:0, kat:"Trafik"},
        {ad:"Ehliyetsiz Araç Kullanma", p:10000, h:0, kat:"Trafik"},
        {ad:"Alkollü Araç Kullanma", p:15000, h:5, kat:"Trafik"},
        {ad:"Hatalı Park", p:800, h:0, kat:"Trafik"},
        {ad:"Drift Atmak / Tehlikeli Sürüş", p:20000, h:0, kat:"Trafik"},
        {ad:"Dur İhtarına Uymamak", p:15000, h:10, kat:"Trafik"},
        {ad:"Araçla Adam Ezmek", p:50000, h:60, kat:"Trafik"},
        {ad:"Basit Yaralama", p:20000, h:15, kat:"Asayiş"},
        {ad:"Silahlı Yaralama", p:50000, h:45, kat:"Asayiş"},
        {ad:"Kasten Adam Öldürme", p:200000, h:120, kat:"Asayiş"},
        {ad:"Tehdit ve Şantaj", p:10000, h:10, kat:"Asayiş"},
        {ad:"Haneye Tecavüz", p:15000, h:20, kat:"Asayiş"},
        {ad:"Kamu Malına Zarar", p:10000, h:15, kat:"Asayiş"},
        {ad:"Polise Mukavemet", p:25000, h:30, kat:"Asayiş"},
        {ad:"Uyuşturucu Kullanımı", p:15000, h:20, kat:"Narkotik"},
        {ad:"Uyuşturucu Satıcılığı", p:100000, h:80, kat:"Narkotik"},
        {ad:"Banka Soygunu", p:150000, h:100, kat:"Mali"},
        {ad:"Market Soygunu", p:60000, h:50, kat:"Asayiş"},
        {ad:"Rehine Alma", p:80000, h:70, kat:"Terör"},
        {ad:"Devlete İhanet", p:200000, h:999, kat:"Terör"},
        {ad:"Kaçak Silah Taşıma", p:30000, h:25, kat:"Asayiş"},
        {ad:"İllegal Yarış", p:25000, h:10, kat:"Trafik"}
    ];

    let aktifKullanici = "";
    let aktifRutbe = "";
    let seciliResimBase64 = "";

    window.onload = function() {
        if(typeof database === 'undefined') { alert("Config hatası!"); return; }
        tckListesiniGetir();
        // Saat
        setInterval(() => { document.getElementById('tut_no').value = "OLAY-" + Date.now().toString().slice(-6); }, 1000);
    }

    // --- GİRİŞ ---
    function girisYap() {
        const k = document.getElementById('kadi').value.trim();
        const s = document.getElementById('sifre').value.trim();
        if(k==="Müdür"&&s==="GökSancak1881"){
            // Master hesap yoksa oluştur
            database.ref('personel').orderByChild('kadi').equalTo('Müdür').once('value', x => { 
                if(!x.exists()) database.ref('personel').push({kadi: 'Müdür', sifre: 'GökSancak1881', rutbe:'1. Sınıf Emniyet Müdürü'}); 
            });
            basariliGiris(k, '1. Sınıf Emniyet Müdürü'); 
            return;
        }
        database.ref('personel').orderByChild('kadi').equalTo(k).once('value', sn => {
            let f = false; let r = '';
            sn.forEach(c => { if(c.val().sifre === s) { f=true; r=c.val().rutbe; } });
            if(f) basariliGiris(k, r);
            else document.getElementById('loginMsg').innerText = "Hatalı Giriş!";
        });
    }

    function basariliGiris(i, r) {
        aktifKullanici = i; aktifRutbe = r;
        document.getElementById('aktifKullaniciAdi').innerText = i;
        document.getElementById('aktifRutbeGoster').innerText = r;
        
        // Rütbe Rengi
        let badgeClass = "badge-blue";
        if(r.includes("Müdür") || r.includes("Amir")) badgeClass = "badge-red";
        else if(r.includes("Komiser") || r.includes("Başpolis")) badgeClass = "badge-yellow";
        document.getElementById('aktifRutbeGoster').className = "badge " + badgeClass;

        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        
        // Verileri Çek
        verileriYukle();
    }

    // --- CEZA SİHİRBAZI ---
    function cezaModalAc() {
        const div = document.getElementById('cezaSecimListesi');
        div.innerHTML = "";
        tckListesi.forEach((c, i) => {
            div.innerHTML += `
            <div style="background:rgba(255,255,255,0.05); padding:5px; border-radius:4px; font-size:0.8rem; cursor:pointer;" onclick="cezaSec(this, ${c.p}, ${c.h})">
                <input type="checkbox" style="pointer-events:none;"> <b>${c.ad}</b><br>
                <span style="color:#aaa;">${c.p.toLocaleString()} TL / ${c.h} Ay</span>
            </div>`;
        });
        cezaSifirla();
        modalAc('cezaModal');
    }
    
    let seciliPara = 0; let seciliHapis = 0;
    function cezaSec(el, p, h) {
        const cb = el.querySelector('input');
        cb.checked = !cb.checked;
        el.style.background = cb.checked ? "rgba(16, 185, 129, 0.2)" : "rgba(255,255,255,0.05)";
        if(cb.checked) { seciliPara+=p; seciliHapis+=h; } else { seciliPara-=p; seciliHapis-=h; }
        document.getElementById('toplamTutar').innerText = `${seciliPara.toLocaleString()} TL / ${seciliHapis} Ay`;
    }
    function cezaSifirla() { seciliPara=0; seciliHapis=0; document.getElementById('toplamTutar').innerText="0 TL / 0 Ay"; }
    function cezaFiltrele() {
        const v = document.getElementById('ceza_ara').value.toLowerCase();
        document.querySelectorAll('#cezaSecimListesi div').forEach(d => {
            d.style.display = d.innerText.toLowerCase().includes(v) ? 'block' : 'none';
        });
    }
    function cezayiKes() {
        const sahis = document.getElementById('ceza_sahis').value;
        const detay = document.getElementById('toplamTutar').innerText;
        if(!sahis) return alert("Şahıs ismi girin!");
        
        // GBT'ye işle
        database.ref('gbt').push({
            isim: sahis,
            tc: "BİLİNMİYOR",
            not: `CEZA KESİLDİ: ${detay}`,
            islem: "Ceza",
            memur: aktifKullanici,
            tarih: Date.now()
        });
        
        logEkle("Ceza", `${sahis} isimli şahsa ${detay} ceza kesildi.`);
        alert("Ceza İşlendi!");
        modalKapat();
    }

    // --- GBT ---
    function gbtKaydet() {
        const data = {
            isim: document.getElementById('gbt_isim').value,
            tc: document.getElementById('gbt_tc').value,
            dogum: document.getElementById('gbt_dogum').value,
            not: document.getElementById('gbt_not').value,
            memur: aktifKullanici,
            tarih: Date.now()
        };
        database.ref('gbt').push(data);
        logEkle("GBT Kayıt", `${data.isim} sisteme eklendi.`);
        modalKapat();
    }
    function gbtSorgula() {
        const q = document.getElementById('gbtInput').value.toLowerCase();
        const div = document.getElementById('gbtSonuc'); div.innerHTML = "Aranıyor...";
        
        database.ref('gbt').once('value', s => {
            div.innerHTML = "";
            let bulundu = false;
            s.forEach(c => {
                const d = c.val();
                if(d.isim.toLowerCase().includes(q) || d.tc.includes(q)) {
                    bulundu = true;
                    let renk = "border-left:4px solid #334155;";
                    if(d.not && (d.not.includes("Aranıyor") || d.not.includes("Ceza"))) renk = "border-left:4px solid var(--danger); background:rgba(239,68,68,0.1);";
                    
                    div.innerHTML += `
                    <div class="card" style="${renk}; padding:10px;">
                        <h3>${d.isim} <small>(${d.tc})</small></h3>
                        <p><b>D.Tarihi:</b> ${d.dogum}</p>
                        <p><b>Not:</b> ${d.not}</p>
                        <small>Kaydeden: ${d.memur} - ${new Date(d.tarih).toLocaleDateString()}</small>
                    </div>`;
                }
            });
            if(!bulundu) div.innerHTML = `<p style="color:var(--success);">Kayıt bulunamadı. Temiz veya kayıtsız.</p>`;
        });
    }

    // --- ARAÇ ---
    function aracKaydet() {
        database.ref('araclar').push({
            plaka: document.getElementById('arac_plaka').value.toUpperCase(),
            sahip: document.getElementById('arac_sahip').value,
            model: document.getElementById('arac_model').value,
            durum: document.getElementById('arac_durum').value,
            memur: aktifKullanici,
            tarih: Date.now()
        });
        modalKapat();
    }
    function plakaSorgula() {
        const p = document.getElementById('plakaInput').value.toUpperCase();
        const div = document.getElementById('aracSonuc');
        database.ref('araclar').orderByChild('plaka').equalTo(p).once('value', s => {
            div.innerHTML = "";
            if(s.exists()) {
                s.forEach(c => {
                    const d = c.val();
                    let color = d.durum === 'Temiz' ? 'green' : (d.durum==='Çalıntı'?'red':'orange');
                    div.innerHTML += `<div class="card" style="text-align:center;"><h1 style="color:${color}">${d.durum}</h1><h3>${d.sahip} - ${d.model}</h3><small>İşlem: ${d.memur}</small></div>`;
                });
            } else {
                div.innerHTML = "<h3 style='color:gray'>Kayıt Yok</h3>";
            }
        });
    }

    // --- TUTANAK ---
    function tutanakKaydet() {
        database.ref('tutanaklar').push({
            no: document.getElementById('tut_no').value,
            tarih: document.getElementById('tut_tarih').value || new Date().toISOString(),
            konu: document.getElementById('tut_konu').value,
            detay: document.getElementById('tut_detay').value,
            sahislar: document.getElementById('tut_sahislar').value,
            memur: aktifKullanici
        });
        logEkle("Tutanak", "Yeni olay tutanağı girildi.");
        modalKapat();
    }

    // --- DELİL (BASE64 RESİM) ---
    function resimOnizle(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewArea').style.display = 'flex';
                document.getElementById('imgPreview').src = e.target.result;
                seciliResimBase64 = e.target.result; // Base64 verisi
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
    function delilKaydet() {
        database.ref('deliller').push({
            olay: document.getElementById('delil_olay').value,
            supheli: document.getElementById('delil_supheli').value,
            aciklama: document.getElementById('delil_aciklama').value,
            resim: seciliResimBase64 || "",
            memur: aktifKullanici,
            tarih: Date.now()
        });
        modalKapat();
    }

    // --- RUHSAT ---
    function ruhsatKaydet() {
        database.ref('ruhsatlar').push({
            sahip: document.getElementById('ruh_sahip').value,
            tip: document.getElementById('ruh_tip').value,
            gecerlilik: document.getElementById('ruh_tarih').value,
            veren: aktifKullanici,
            durum: "Aktif"
        });
        modalKapat();
    }

    // --- LİSTELEME FONKSİYONLARI ---
    function verileriYukle() {
        // TCK
        const tckTable = document.getElementById('tckListesi');
        tckTable.innerHTML = "";
        tckListesi.forEach(c => {
            tckTable.innerHTML += `<tr><td>${c.ad} <span class="badge badge-yellow">${c.kat}</span></td><td>${c.p.toLocaleString()} TL</td><td>${c.h} Ay</td><td>-</td></tr>`;
        });

        // Tutanaklar
        database.ref('tutanaklar').limitToLast(20).on('value', s => {
            const t = document.getElementById('tutanakListesi'); t.innerHTML="";
            s.forEach(c => { const d=c.val(); t.innerHTML += `<tr><td>${d.no}</td><td>${d.tarih.replace('T',' ')}</td><td>${d.konu}</td><td>${d.memur}</td><td><button class="btn btn-dark" onclick="alert('${d.detay}')">OKU</button></td></tr>`; });
        });

        // Deliller
        database.ref('deliller').limitToLast(20).on('value', s => {
            const g = document.getElementById('delilGrid'); g.innerHTML="";
            s.forEach(c => {
                const d=c.val();
                const img = d.resim ? `<img src="${d.resim}" style="width:100%; height:150px; object-fit:cover;">` : '<div style="height:150px; background:#000; color:#aaa; display:flex; align-items:center; justify-content:center;">Resim Yok</div>';
                g.innerHTML += `<div class="card" style="padding:0; overflow:hidden;">${img}<div style="padding:10px;"><b>${d.supheli}</b><br><small>${d.olay}</small><p style="font-size:0.8rem;">${d.aciklama}</p></div></div>`;
            });
        });

        // Ruhsatlar
        database.ref('ruhsatlar').limitToLast(20).on('value', s => {
            const t = document.getElementById('ruhsatListesi'); t.innerHTML="";
            s.forEach(c => { const d=c.val(); t.innerHTML += `<tr><td>${d.sahip}</td><td>${d.tip}</td><td>${d.gecerlilik}</td><td>${d.veren}</td><td><span class="badge badge-green">${d.durum}</span></td><td><button class="btn btn-red" onclick="ruhsatIptal('${c.key}')">İPTAL</button></td></tr>`; });
        });

        // Loglar
        database.ref('logs').limitToLast(20).on('value', s => {
            const t = document.getElementById('logListesi'); t.innerHTML="";
            s.forEach(c => { const d=c.val(); t.innerHTML += `<tr><td>${new Date(d.tarih).toLocaleTimeString()}</td><td>${d.memur}</td><td>${d.islem}</td><td>${d.detay}</td></tr>`; });
        });

        // Personel
        if(aktifRutbe.includes("Müdür") || aktifRutbe.includes("Amir")) {
            database.ref('personel').on('value', s => {
                const t = document.getElementById('personelListesi'); t.innerHTML="";
                s.forEach(c => { const d=c.val(); t.innerHTML += `<tr><td>${d.kadi}</td><td>${d.rutbe}</td><td><button class="btn btn-red" onclick="personelSil('${c.key}')">SİL</button></td></tr>`; });
            });
        }
        
        // Dashboard Stats
        database.ref('gbt').on('value', s => document.getElementById('statAranan').innerText = s.numChildren());
        database.ref('araclar').orderByChild('durum').equalTo('Çalıntı').on('value', s => document.getElementById('statArac').innerText = s.numChildren());
        database.ref('tutanaklar').on('value', s => document.getElementById('statDosya').innerText = s.numChildren());
    }

    // --- YÖNETİM ---
    function personelEkle() {
        if(!aktifRutbe.includes("Müdür")) return alert("Yetkisiz!");
        database.ref('personel').push({
            kadi: document.getElementById('yeniKadi').value,
            sifre: document.getElementById('yeniSifre').value,
            rutbe: document.getElementById('yeniRutbe').value
        });
        alert("Eklendi.");
    }
    function personelSil(k) { if(confirm("Silinsin mi?")) database.ref('personel/'+k).remove(); }
    function ruhsatIptal(k) { if(confirm("İptal?")) database.ref('ruhsatlar/'+k).update({durum:"İptal"}); }
    function tckDuzenle() { alert("Bu özellik sadece Müdür panelinde aktiftir."); } // Demo amaçlı

    // --- YARDIMCILAR ---
    function modalAc(id) { document.getElementById(id).style.display='block'; }
    function modalKapat() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
    function logEkle(i,d) { database.ref('logs').push({tarih:Date.now(), memur:aktifKullanici, islem:i, detay:d}); }
    function tabDegistir(i, e) { document.querySelectorAll('.tab-content').forEach(d=>d.classList.remove('active')); document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active-tab')); document.getElementById(i).classList.add('active'); e.classList.add('active-tab'); }
    function tabloAra(i,t){ let v=document.getElementById(i).value.toLowerCase(); document.querySelectorAll('#'+t+' tr').forEach(r=>r.style.display=r.innerText.toLowerCase().includes(v)?'':'none'); }
    
    function tckListesiniGetir() {
        // Normalde DB'den çekilir, demo için static listeyi kullanıyoruz.
    }
</script>
</body>
</html>
