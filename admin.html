<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>EGM Personel Y√∂netim</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://meet.jit.si/external_api.js"></script>

    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; background: #162447; color: white; display: flex; flex-direction: column; padding: 20px; z-index: 2; }
        .content { flex: 1; padding: 40px; overflow-y: auto; background: #eef2f5; position: relative; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-top: 20px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #1f4068; color: white; }
        
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; margin-right: 5px; font-weight: bold; font-size: 0.9rem; transition: 0.2s; }
        .btn:hover { opacity: 0.8; }
        .btn-green { background: #28a745; } .btn-red { background: #dc3545; } .btn-blue { background: #007bff; } .btn-dark { background: #343a40; } .btn-yellow { background: #f1c40f; color: #333; }
        .discord-link { color: #5865F2; font-weight: bold; text-decoration: none; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 70%; max-width: 900px; border-radius: 10px; }
        .modal-header { padding: 20px; background-color: #162447; color: white; display: flex; justify-content: space-between; align-items: center; border-radius: 10px 10px 0 0; }
        .modal-body { padding: 30px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 15px; background-color: #eee; text-align: right; border-radius: 0 0 10px 10px; }
        .soru-item { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .soru-baslik { font-weight: bold; color: #162447; display: block; margin-bottom: 5px; font-size: 1.1rem; }
        .cevap-metni { color: #333; font-size: 1rem; white-space: pre-wrap; background: #f9f9f9; padding: 10px; border-radius: 5px; border-left: 4px solid #ffd700; }
        
        #loginScreen { position: fixed; top:0; left:0; width:100%; height:100%; background: #162447; z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 10px; width: 350px; text-align: center; }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .menu-item { padding: 15px; cursor: pointer; color: #ccc; } .menu-item:hover, .active-tab { color: white; background: rgba(255,255,255,0.1); border-radius: 5px; }
        .webhook-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; margin-top: 20px; font-size: 0.8rem; display: none; }
        .webhook-input { width: 100%; padding: 5px; margin-top: 5px; box-sizing: border-box; border: none; border-radius: 3px; }

        /* --- TS3 TARZI SOHBET VE SES Sƒ∞STEMƒ∞ --- */
        .ts3-container { display: flex; height: 75vh; gap: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        /* Sol: Aktif Kullanƒ±cƒ±lar & Ses Kontrol */
        .ts3-sidebar { width: 280px; background: #2c3e50; color: white; padding: 0; display: flex; flex-direction: column; border-right: 3px solid #162447; }
        .ts3-header { padding: 15px; font-size: 0.9rem; text-transform: uppercase; color: #95a5a6; border-bottom: 1px solid #34495e; background: #202d3a; }
        
        .voice-control-panel { padding: 15px; background: #e74c3c; text-align: center; transition: 0.3s; }
        .voice-control-panel.active { background: #27ae60; }
        .voice-status-text { font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.9rem; }
        .btn-voice { padding: 8px 20px; border: none; border-radius: 20px; cursor: pointer; background: white; color: #333; font-weight: bold; font-size: 0.8rem; }

        .online-list { flex: 1; padding: 10px; overflow-y: auto; }
        .online-user { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 4px; font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .status-dot { width: 10px; height: 10px; background: #95a5a6; border-radius: 50%; } /* Default */
        .status-online { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; } 
        
        /* Saƒü: Sohbet Alanƒ± */
        .ts3-chat-area { flex: 1; display: flex; flex-direction: column; background: #ecf0f1; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 80%; padding: 10px; border-radius: 8px; font-size: 0.95rem; line-height: 1.4; }
        .msg-mine { align-self: flex-end; background: #3498db; color: white; border-bottom-right-radius: 0; }
        .msg-other { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 0; border: 1px solid #ddd; }
        .msg-sender { font-size: 0.75rem; opacity: 0.8; margin-bottom: 3px; font-weight: bold; display: block; }
        .msg-time { font-size: 0.7rem; opacity: 0.6; float: right; margin-left: 10px; margin-top: 5px; }
        
        .chat-input-area { padding: 15px; background: white; border-top: 1px solid #ccc; display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .btn-send { padding: 0 20px; background: #162447; color: white; border: none; border-radius: 5px; cursor: pointer; }

        /* Jitsi Gizli Frame */
        #jitsi-container { width: 100%; height: 0px; overflow: hidden; /* Gizli ama √ßalƒ±≈üƒ±r */ }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <h2 style="color:#162447;">Y√ñNETƒ∞M PANELƒ∞</h2>
        <input type="text" id="kadi" class="login-input" placeholder="Kullanƒ±cƒ± Adƒ±">
        <input type="password" id="sifre" class="login-input" placeholder="≈ûifre">
        <button onclick="girisYap()" class="btn btn-blue" style="width:100%; padding:12px; margin-top:10px;">Giri≈ü Yap</button>
        <p id="loginMsg" style="color:red; margin-top:10px;"></p>
    </div>
</div>

<div id="detayModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalBaslik" style="margin:0;">Ba≈üvuru Detayƒ±</h2>
            <span onclick="modalKapat()" style="cursor:pointer; font-size:24px;">&times;</span>
        </div>
        <div class="modal-body" id="modalIcerik"></div>
        <div class="modal-footer">
            <button onclick="modalKapat()" class="btn btn-red">Kapat</button>
        </div>
    </div>
</div>

<div id="adminPanel" style="display:none; width:100%;">
    <div class="sidebar">
        <h2 style="color:#ffd700; text-align:center;">M√úD√úRL√úK</h2>
        <div class="menu-item active-tab" onclick="tabDegistir('basvurularTab', this)">üìÑ Ba≈üvurular</div>
        <div class="menu-item" onclick="tabDegistir('yoneticilerTab', this)">üëÆ‚Äç‚ôÇÔ∏è Personel</div>
        <div class="menu-item" onclick="tabDegistir('sohbetTab', this)">üéôÔ∏è Komuta Merkezi</div>
        
        <div id="webhookAyarKutusu" class="webhook-box">
            <label>Discord Webhook URL:</label>
            <input type="password" id="webhookUrl" class="webhook-input" placeholder="Webhook URL..." onchange="webhookKaydet()">
        </div>

        <div class="menu-item" onclick="location.reload()" style="margin-top:auto; color:#e43f5a;">üö™ √áƒ±kƒ±≈ü</div>
    </div>

    <div class="content">
        <div id="basvurularTab" class="tab-content active">
            <h2 style="color:#162447;">Gelen Ba≈üvurular</h2>
            <table>
                <thead><tr><th>Discord ID</th><th>IC ƒ∞sim</th><th>Durum</th><th>ƒ∞≈ülem</th></tr></thead>
                <tbody id="basvuruListesi"></tbody>
            </table>
        </div>

        <div id="yoneticilerTab" class="tab-content">
            <h2 style="color:#162447;">Personel Listesi</h2>
            <div style="background:white; padding:20px; margin-bottom:20px;">
                <input type="text" id="yeniKadi" placeholder="Kullanƒ±cƒ± Adƒ±" style="padding:8px;">
                <input type="password" id="yeniSifre" placeholder="≈ûifre" style="padding:8px;">
                <button onclick="yetkiliEkle()" class="btn btn-green">Ekle</button>
            </div>
            <table>
                <thead><tr><th>Kullanƒ±cƒ±</th><th>≈ûifre</th><th>ƒ∞≈ülem</th></tr></thead>
                <tbody id="yoneticiListesi"></tbody>
            </table>
        </div>

        <div id="sohbetTab" class="tab-content">
            <h2 style="color:#162447;">Komuta Kontrol & Telsiz</h2>
            <div class="ts3-container">
                <div class="ts3-sidebar">
                    <div id="voicePanel" class="voice-control-panel">
                        <span id="voiceStatusText" class="voice-status-text">SES BAƒûLANTISI YOK</span>
                        <button onclick="sesliSohbeteBaglan()" id="btnVoice" class="btn-voice">BAƒûLAN</button>
                    </div>
                    
                    <div id="jitsi-container"></div>

                    <div class="ts3-header">AKTƒ∞F PERSONEL</div>
                    <div id="onlineUsersList" class="online-list"></div>
                </div>
                
                <div class="ts3-chat-area">
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-area">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Telsiz mesajƒ± g√∂nder..." onkeydown="enterBas(event)">
                        <button onclick="mesajGonder()" class="btn-send">G√ñNDER</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="config.js"></script>
<script>
    const yedekSozluk = {"discord_id": "Discord ID", "ic_isim": "IC ƒ∞sim Soyisim", "ooc_yas": "OOC Ya≈ü", "aktiflik": "G√ºnl√ºk Aktiflik", "karakter_hikaye": "Karakter Hikayesi", "deneyim": "FiveM Deneyimi"};
    let basvuruVerileri = {};
    let aktifKullanici = "";
    let jitsiApi = null; 

    window.onload = function() {
        const kayitliWebhook = localStorage.getItem('discordWebhook');
        if(kayitliWebhook) document.getElementById('webhookUrl').value = kayitliWebhook;
    }

    function webhookKaydet() {
        const url = document.getElementById('webhookUrl').value;
        localStorage.setItem('discordWebhook', url);
    }

    function girisYap() {
        const kadi = document.getElementById('kadi').value.trim();
        const sifre = document.getElementById('sifre').value.trim();
        
        if (kadi === "M√ºd√ºr" && sifre === "G√∂kSancak1881") { 
            basariliGiris("M√ºd√ºr");
            database.ref('yetkililer').orderByChild('kadi').equalTo('M√ºd√ºr').once('value', s => { 
                if(!s.exists()) database.ref('yetkililer').push({kadi: 'M√ºd√ºr', sifre: 'G√∂kSancak1881'}); 
            }); 
            return; 
        }

        database.ref('yetkililer').orderByChild('kadi').equalTo(kadi).once('value', snapshot => { 
            let ok = false; 
            snapshot.forEach(c => { if(c.val().sifre === sifre) ok = true; }); 
            if(ok) { basariliGiris(kadi); } 
            else { document.getElementById('loginMsg').innerText = "Hatalƒ± Giri≈ü!"; }
        });
    }

    function basariliGiris(kullaniciAdi) {
        aktifKullanici = kullaniciAdi;
        let isMudur = (kullaniciAdi === 'M√ºd√ºr');
        
        const userStatusRef = database.ref('status/' + kullaniciAdi);
        userStatusRef.set({ state: 'online', last_changed: firebase.database.ServerValue.TIMESTAMP });
        userStatusRef.onDisconnect().remove();

        panelAc(isMudur);
    }

    function panelAc(isMudur) { 
        document.getElementById('loginScreen').style.display = 'none'; 
        document.getElementById('adminPanel').style.display = 'flex'; 
        
        if(isMudur) document.getElementById('webhookAyarKutusu').style.display = 'block';
        else document.getElementById('webhookAyarKutusu').style.display = 'none';

        verileriGetir(); 
        yoneticileriGetir(); 
        sohbetVeDurumBaslat();
    }

    // --- SESLƒ∞ SOHBET (JITSI) ---
    function sesliSohbeteBaglan() {
        const btn = document.getElementById('btnVoice');
        const panel = document.getElementById('voicePanel');
        const txt = document.getElementById('voiceStatusText');

        if(jitsiApi) {
            // Baƒülantƒ±yƒ± Kes
            jitsiApi.dispose();
            jitsiApi = null;
            btn.innerText = "BAƒûLAN";
            txt.innerText = "SES BAƒûLANTISI YOK";
            panel.classList.remove('active');
        } else {
            // Baƒülan
            btn.innerText = "AYRIL";
            txt.innerText = "TELSƒ∞Z AKTƒ∞F";
            panel.classList.add('active');

            const domain = "meet.jit.si";
            const options = {
                roomName: "EGM-Polnet-Yonetim-Odasi-Gizli-82736", // Odayƒ± benzersiz yap
                width: "100%",
                height: 200,
                parentNode: document.querySelector('#jitsi-container'),
                configOverwrite: { startWithAudioMuted: false, startWithVideoMuted: true }, // Kamerasƒ±z ba≈üla
                interfaceConfigOverwrite: { 
                    TOOLBAR_BUTTONS: ['microphone', 'camera', 'tileview', 'hangup'], 
                    SHOW_JITSI_WATERMARK: false 
                },
                userInfo: {
                    displayName: aktifKullanici
                }
            };
            jitsiApi = new JitsiMeetExternalAPI(domain, options);
        }
    }

    // --- SOHBET VE DURUM ---
    function sohbetVeDurumBaslat() {
        database.ref('status').on('value', snapshot => {
            const listDiv = document.getElementById('onlineUsersList');
            listDiv.innerHTML = "";
            snapshot.forEach(child => {
                listDiv.innerHTML += `<div class="online-user"><div class="status-dot status-online"></div><strong>${child.key}</strong></div>`;
            });
        });

        database.ref('chat').limitToLast(50).on('child_added', snapshot => {
            const data = snapshot.val();
            const chatDiv = document.getElementById('chatMessages');
            let tip = (data.gonderen === aktifKullanici) ? 'msg-mine' : 'msg-other';
            let zaman = new Date(data.zaman).toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'});
            chatDiv.innerHTML += `<div class="message ${tip}"><span class="msg-sender">${data.gonderen}</span>${data.mesaj}<span class="msg-time">${zaman}</span></div>`;
            chatDiv.scrollTop = chatDiv.scrollHeight;
        });
    }

    function mesajGonder() {
        const input = document.getElementById('chatInput');
        const msg = input.value.trim();
        if(msg) {
            database.ref('chat').push({ gonderen: aktifKullanici, mesaj: msg, zaman: firebase.database.ServerValue.TIMESTAMP });
            input.value = "";
        }
    }
    function enterBas(e) { if(e.key === 'Enter') mesajGonder(); }

    // --- Dƒ∞ƒûER FONKSƒ∞YONLAR ---
    function verileriGetir() {
        database.ref('basvurular').on('value', snapshot => {
            const liste = document.getElementById('basvuruListesi'); liste.innerHTML = ""; basvuruVerileri = {};
            if(!snapshot.exists()) { liste.innerHTML = "<tr><td colspan='4'>Ba≈üvuru yok.</td></tr>"; return; }
            snapshot.forEach(child => {
                const data = child.val(); const key = child.key; basvuruVerileri[key] = data;
                let renk = data.durum==='Onaylandƒ±'?'green':(data.durum==='Reddedildi'?'red':'orange');
                let durumYazi = data.durum==='Beklemede'?'DEƒûERLENDƒ∞Rƒ∞Lƒ∞YOR':data.durum;
                liste.innerHTML += `<tr><td>${data.discord_id}</td><td>${data.ic_isim}</td><td style="color:${renk}; font-weight:bold;">${durumYazi}</td><td><button onclick="detayAc('${key}')" class="btn btn-blue">ƒ∞ncele</button><button onclick="onayla('${key}')" class="btn btn-green">‚úì</button><button onclick="reddet('${key}')" class="btn btn-red">‚úó</button><button onclick="dbSil('basvurular/${key}')" class="btn btn-dark">üóëÔ∏è</button></td></tr>`;
            });
        });
    }

    function onayla(key) { if(confirm("Onaylamak istiyor musun?")) database.ref('basvurular/'+key).update({durum: 'Onaylandƒ±'}); }
    function reddet(key) { let s = prompt("Red sebebi:"); if(s) database.ref('basvurular/'+key).update({ durum: 'Reddedildi', red_sebebi: s }); }
    
    function detayAc(key) {
        const data = basvuruVerileri[key]; document.getElementById('modalBaslik').innerText = `${data.ic_isim} - Detay`; let html = "";
        if(data.cevaplar) { for (const [id, val] of Object.entries(data.cevaplar)) { let txt = (data.soru_detaylari && data.soru_detaylari[id]) ? data.soru_detaylari[id] : (yedekSozluk[id] || id); html += `<div class="soru-item"><span class="soru-baslik">${txt}</span><div class="cevap-metni">${val}</div></div>`; } } else { html = "<p>Veri yok.</p>"; }
        if(data.red_sebebi) html += `<div style="margin-top:20px; border:2px solid red; padding:10px; border-radius:5px; color:red;"><strong>RED SEBEBƒ∞:</strong> ${data.red_sebebi}</div>`;
        document.getElementById('modalIcerik').innerHTML = html; document.getElementById('detayModal').style.display = "block";
    }
    function modalKapat() { document.getElementById('detayModal').style.display = "none"; }

    function yoneticileriGetir() { 
        database.ref('yetkililer').on('value', s => { 
            const l = document.getElementById('yoneticiListesi'); l.innerHTML = ""; 
            s.forEach(c => { 
                let data = c.val();
                let isMudurAccount = (data.kadi === 'M√ºd√ºr');
                let silBtn = (aktifKullanici === "M√ºd√ºr" && !isMudurAccount) ? `<button onclick="dbSil('yetkililer/${c.key}')" class="btn btn-red">Sil</button>` : `üîí`;
                let sifreBtn = `<button onclick="sifreDegistir('${c.key}', '${data.kadi}')" class="btn btn-yellow">≈ûifre</button>`;
                l.innerHTML += `<tr><td>${data.kadi}</td><td>‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td><td>${sifreBtn} ${silBtn}</td></tr>`; 
            }); 
        }); 
    }
    
    function sifreDegistir(key, kadi) {
        let yeniSifre = prompt(`"${kadi}" i√ßin yeni ≈üifre:`);
        if(yeniSifre && yeniSifre.trim() !== "") {
            database.ref('yetkililer/'+key).update({sifre: yeniSifre.trim()});
            alert("≈ûifre g√ºncellendi!");
        }
    }

    function yetkiliEkle() { const k=document.getElementById('yeniKadi').value.trim(), s=document.getElementById('yeniSifre').value.trim(); if(k&&s) { database.ref('yetkililer').push({kadi:k, sifre:s}); alert("Eklendi."); } }
    function dbSil(y) { if(confirm('Silinsin mi?')) database.ref(y).remove(); }
    function tabDegistir(id, el) { document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active')); document.getElementById(id).classList.add('active'); }
</script>
</body>
</html>
