<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>EGM Personel YÃ¶netim</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://meet.jit.si/external_api.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-color: #f0f2f5;
            --text-color: #333;
            --sidebar-bg: #162447;
            --sidebar-text: white;
            --card-bg: white;
            --table-header: #1f4068;
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --text-color: #e2e8f0;
            --sidebar-bg: #020617;
            --sidebar-text: #94a3b8;
            --card-bg: #1e293b;
            --table-header: #334155;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; transition: 0.3s; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; padding: 20px; z-index: 2; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
        .content { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        
        /* MenÃ¼ Ã–ÄŸeleri */
        .menu-item { padding: 12px 15px; cursor: pointer; color: inherit; border-radius: 8px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .menu-item:hover, .active-tab { background: rgba(255,255,255,0.1); color: #fff; transform: translateX(5px); }
        .menu-icon { width: 20px; text-align: center; }

        /* Dashboard KartlarÄ± */
        .stats-container { display: flex; gap: 20px; margin-bottom: 30px; }
        .stat-card { flex: 1; background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; border-left: 5px solid #007bff; }
        .stat-info h3 { margin: 0; font-size: 2rem; color: var(--text-color); }
        .stat-info p { margin: 0; color: #888; font-size: 0.9rem; text-transform: uppercase; }
        .stat-icon { font-size: 2.5rem; opacity: 0.2; }

        /* Tablolar */
        table { width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.1); }
        th { background: var(--table-header); color: white; }
        tr:hover { background: rgba(0,0,0,0.02); }

        /* Butonlar */
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-green { background: #10b981; color: white; } 
        .btn-red { background: #ef4444; color: white; } 
        .btn-blue { background: #3b82f6; color: white; } 
        .btn-dark { background: #374151; color: white; } 
        .btn-yellow { background: #f59e0b; color: white; }
        
        /* Arama Kutusu */
        .search-box { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 8px; background: var(--card-bg); color: var(--text-color); }

        /* Login EkranÄ± */
        #loginScreen { position: fixed; top:0; left:0; width:100%; height:100%; background: #0f172a; z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 350px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }

        /* Telsiz & Chat */
        .radio-room-container { display: flex; height: 70vh; gap: 20px; }
        .radio-control { width: 300px; background: var(--sidebar-bg); border-radius: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .chat-area { flex: 1; background: var(--card-bg); border-radius: 10px; display: flex; flex-direction: column; border: 1px solid #ddd; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { padding: 10px; border-radius: 8px; max-width: 80%; font-size: 0.9rem; }
        .msg-mine { align-self: flex-end; background: #3b82f6; color: white; }
        .msg-other { align-self: flex-start; background: #f1f5f9; color: #333; }

        /* YardÄ±mcÄ±lar */
        .tab-content { display: none; animation: fadeIn 0.3s; } 
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); margin: 5% auto; padding: 0; width: 60%; border-radius: 10px; overflow: hidden; }
        
        .webhook-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; margin-top: auto; font-size: 0.8rem; display: none; }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <img src="egmm.png" style="width:80px; margin-bottom:10px;">
        <h2 style="color:#1e293b; margin:0;">YÃ–NETÄ°M PANELÄ°</h2>
        <p style="color:#64748b; font-size:0.9rem;">Personel Daire BaÅŸkanlÄ±ÄŸÄ±</p>
        <input type="text" id="kadi" class="login-input" placeholder="KullanÄ±cÄ± AdÄ±">
        <input type="password" id="sifre" class="login-input" placeholder="Åžifre">
        <button onclick="girisYap()" class="btn btn-blue" style="width:100%; padding:12px; margin-top:10px;">GiriÅŸ Yap</button>
        <p id="loginMsg" style="color:red; margin-top:10px; font-size:0.9rem;"></p>
    </div>
</div>

<div id="detayModal" class="modal">
    <div class="modal-content">
        <div style="padding:20px; background:var(--sidebar-bg); color:white; display:flex; justify-content:space-between;">
            <h3 style="margin:0" id="modalBaslik">BaÅŸvuru DetayÄ±</h3>
            <span onclick="modalKapat()" style="cursor:pointer; font-size:1.5rem;">&times;</span>
        </div>
        <div id="modalIcerik" style="padding:30px; max-height:60vh; overflow-y:auto; color:var(--text-color);"></div>
        <div style="padding:15px; background:rgba(0,0,0,0.05); text-align:right;">
            <button onclick="modalKapat()" class="btn btn-red">Kapat</button>
        </div>
    </div>
</div>

<div id="adminPanel" style="display:none; width:100%;">
    <div class="sidebar">
        <div style="text-align:center; margin-bottom:30px;">
            <img src="egmm.png" style="width:60px;">
            <h3 style="margin:10px 0 0 0; font-size:1.2rem;">EGM PANEL</h3>
            <span id="aktifKullaniciAdi" style="font-size:0.8rem; color:#94a3b8;">YÃ¶netici</span>
        </div>

        <div class="menu-item active-tab" onclick="tabDegistir('dashboardTab', this)"><div class="menu-icon"><i class="fas fa-home"></i></div> Ã–zet (Dashboard)</div>
        <div class="menu-item" onclick="tabDegistir('basvurularTab', this)"><div class="menu-icon"><i class="fas fa-file-alt"></i></div> BaÅŸvurular</div>
        <div class="menu-item" onclick="tabDegistir('yoneticilerTab', this)"><div class="menu-icon"><i class="fas fa-users-cog"></i></div> Personel</div>
        <div class="menu-item" onclick="tabDegistir('blacklistTab', this)"><div class="menu-icon"><i class="fas fa-ban"></i></div> Kara Liste</div>
        <div class="menu-item" onclick="tabDegistir('logsTab', this)"><div class="menu-icon"><i class="fas fa-history"></i></div> Log KayÄ±tlarÄ±</div>
        <div class="menu-item" onclick="tabDegistir('sohbetTab', this)"><div class="menu-icon"><i class="fas fa-headset"></i></div> Komuta & Telsiz</div>
        
        <div style="margin-top:auto;">
            <div id="webhookAyarKutusu" class="webhook-box">
                <label>Webhook URL:</label>
                <input type="password" id="webhookUrl" style="width:100%; border:none; border-radius:3px; padding:3px;" onchange="webhookKaydet()">
            </div>
            <div class="menu-item" onclick="temaDegistir()"><div class="menu-icon"><i class="fas fa-adjust"></i></div> Tema DeÄŸiÅŸtir</div>
            <div class="menu-item" onclick="location.reload()" style="color:#ef4444;"><div class="menu-icon"><i class="fas fa-sign-out-alt"></i></div> Ã‡Ä±kÄ±ÅŸ Yap</div>
        </div>
    </div>

    <div class="content">
        <div id="dashboardTab" class="tab-content active">
            <h2 style="margin-bottom:20px;">Genel Durum</h2>
            <div class="stats-container">
                <div class="stat-card" style="border-color:#3b82f6;">
                    <div class="stat-info">
                        <h3 id="statToplam">0</h3>
                        <p>Toplam BaÅŸvuru</p>
                    </div>
                    <div class="stat-icon"><i class="fas fa-folder-open"></i></div>
                </div>
                <div class="stat-card" style="border-color:#f59e0b;">
                    <div class="stat-info">
                        <h3 id="statBekleyen">0</h3>
                        <p>Bekleyen</p>
                    </div>
                    <div class="stat-icon"><i class="fas fa-clock"></i></div>
                </div>
                <div class="stat-card" style="border-color:#10b981;">
                    <div class="stat-info">
                        <h3 id="statOnay">0</h3>
                        <p>Onaylanan</p>
                    </div>
                    <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                </div>
                <div class="stat-card" style="border-color:#ef4444;">
                    <div class="stat-info">
                        <h3 id="statRed">0</h3>
                        <p>Reddedilen</p>
                    </div>
                    <div class="stat-icon"><i class="fas fa-times-circle"></i></div>
                </div>
            </div>
        </div>

        <div id="basvurularTab" class="tab-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Gelen BaÅŸvurular</h2>
                <button onclick="excelIndir()" class="btn btn-green"><i class="fas fa-file-excel"></i> Excel Ä°ndir</button>
            </div>
            <input type="text" id="basvuruAra" class="search-box" placeholder="ðŸ” Ä°sim, Discord ID veya Durum Ara..." onkeyup="tabloAra('basvuruAra', 'basvuruListesi')">
            <table>
                <thead><tr><th>Discord ID</th><th>IC Ä°sim</th><th>Durum</th><th>Tarih</th><th>Ä°ÅŸlem</th></tr></thead>
                <tbody id="basvuruListesi"></tbody>
            </table>
        </div>

        <div id="logsTab" class="tab-content">
            <h2>Sistem KayÄ±tlarÄ± (Audit Logs)</h2>
            <input type="text" id="logAra" class="search-box" placeholder="ðŸ” Log Ara..." onkeyup="tabloAra('logAra', 'logListesi')">
            <table>
                <thead><tr><th>Zaman</th><th>YÃ¶netici</th><th>Ä°ÅŸlem</th><th>Detay</th></tr></thead>
                <tbody id="logListesi"></tbody>
            </table>
        </div>

        <div id="yoneticilerTab" class="tab-content">
            <h2>Personel Listesi</h2>
            <div style="background:var(--card-bg); padding:20px; margin-bottom:20px; border-radius:8px;">
                <input type="text" id="yeniKadi" placeholder="KullanÄ±cÄ± AdÄ±" style="padding:8px; border-radius:4px; border:1px solid #ccc;">
                <input type="password" id="yeniSifre" placeholder="Åžifre" style="padding:8px; border-radius:4px; border:1px solid #ccc;">
                <button onclick="yetkiliEkle()" class="btn btn-green">Ekle</button>
            </div>
            <table>
                <thead><tr><th>KullanÄ±cÄ±</th><th>Yetki</th><th>Ä°ÅŸlem</th></tr></thead>
                <tbody id="yoneticiListesi"></tbody>
            </table>
        </div>

        <div id="blacklistTab" class="tab-content">
            <h2 style="color:#ef4444;">Kara Liste</h2>
            <div style="background:var(--card-bg); padding:20px; margin-bottom:20px; border-radius:8px;">
                <input type="text" id="yasakliID" placeholder="Discord ID" style="padding:8px; border:1px solid #ccc; border-radius:4px; width:200px;">
                <input type="text" id="yasakSebep" placeholder="Sebep" style="padding:8px; border:1px solid #ccc; border-radius:4px; width:300px;">
                <button onclick="yasakla()" class="btn btn-red">YASAKLA</button>
            </div>
            <table>
                <thead><tr><th>Discord ID</th><th>Sebep</th><th>Ä°ÅŸlem</th></tr></thead>
                <tbody id="blacklistListesi"></tbody>
            </table>
        </div>

        <div id="sohbetTab" class="tab-content">
            <h2>Komuta Kontrol</h2>
            <div class="radio-room-container">
                <div class="radio-control">
                    <div style="padding:15px; text-align:center; color:#94a3b8; font-weight:bold; background:rgba(0,0,0,0.2);">TELSÄ°Z HATTI</div>
                    <div style="padding:20px; text-align:center;">
                        <button id="btnConnectRadio" onclick="telsizDurumDegistir()" class="btn btn-red" style="width:100%; border-radius:20px;">BAÄžLAN</button>
                    </div>
                    <div id="jitsi-embed-container" style="flex:1; background:black;"></div>
                </div>
                <div class="chat-area">
                    <div style="padding:15px; border-bottom:1px solid #ddd; font-weight:bold;">YazÄ±lÄ± Kanal</div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div style="padding:15px; display:flex; gap:10px;">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Mesaj..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:5px;" onkeydown="enterBas(event)">
                        <button onclick="mesajGonder()" class="btn btn-blue">GÃ–NDER</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="config.js"></script>
<script>
    const bildirimSesi = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
    let basvuruVerileri = {};
    let aktifKullanici = "";
    let jitsiApi = null;

    // --- BAÅžLANGIÃ‡ AYARLARI ---
    window.onload = function() {
        const kayitliWebhook = localStorage.getItem('discordWebhook');
        if(kayitliWebhook) document.getElementById('webhookUrl').value = kayitliWebhook;
        
        // Tema KontrolÃ¼
        if(localStorage.getItem('tema') === 'dark') document.body.setAttribute('data-theme', 'dark');
    }

    // --- TEMA SÄ°STEMÄ° ---
    function temaDegistir() {
        if(document.body.getAttribute('data-theme') === 'dark') {
            document.body.removeAttribute('data-theme');
            localStorage.setItem('tema', 'light');
        } else {
            document.body.setAttribute('data-theme', 'dark');
            localStorage.setItem('tema', 'dark');
        }
    }

    // --- GÄ°RÄ°Åž SÄ°STEMÄ° ---
    function girisYap() {
        const kadi = document.getElementById('kadi').value.trim();
        const sifre = document.getElementById('sifre').value.trim();
        
        if (kadi === "MÃ¼dÃ¼r" && sifre === "GÃ¶kSancak1881") {
            basariliGiris("MÃ¼dÃ¼r");
            database.ref('yetkililer').orderByChild('kadi').equalTo('MÃ¼dÃ¼r').once('value', s => { if(!s.exists()) database.ref('yetkililer').push({kadi: 'MÃ¼dÃ¼r', sifre: 'GÃ¶kSancak1881'}); });
            return;
        }
        database.ref('yetkililer').orderByChild('kadi').equalTo(kadi).once('value', snapshot => {
            let ok = false;
            snapshot.forEach(c => { if(c.val().sifre === sifre) ok = true; });
            if(ok) basariliGiris(kadi); else document.getElementById('loginMsg').innerText = "HatalÄ± GiriÅŸ!";
        });
    }

    function basariliGiris(isim) {
        aktifKullanici = isim;
        document.getElementById('aktifKullaniciAdi').innerText = isim;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'flex';
        
        if(isim === 'MÃ¼dÃ¼r') document.getElementById('webhookAyarKutusu').style.display = 'block';
        
        // Log KaydÄ±
        logKaydet("GiriÅŸ", "Sisteme giriÅŸ yapÄ±ldÄ±.");
        
        verileriGetir();
        yoneticileriGetir();
        blacklistGetir();
        loglariGetir();
        chatBaslat();
    }

    // --- LOG SÄ°STEMÄ° (YENÄ°) ---
    function logKaydet(islem, detay) {
        database.ref('logs').push({
            zaman: firebase.database.ServerValue.TIMESTAMP,
            yonetici: aktifKullanici,
            islem: islem,
            detay: detay
        });
    }

    function loglariGetir() {
        database.ref('logs').limitToLast(100).on('value', snapshot => {
            const liste = document.getElementById('logListesi');
            liste.innerHTML = "";
            let logArr = [];
            snapshot.forEach(child => logArr.push(child.val()));
            logArr.reverse().forEach(log => {
                let tarih = new Date(log.zaman).toLocaleString('tr-TR');
                liste.innerHTML += `<tr><td><small>${tarih}</small></td><td><b>${log.yonetici}</b></td><td>${log.islem}</td><td>${log.detay}</td></tr>`;
            });
        });
    }

    // --- VERÄ° & Ä°STATÄ°STÄ°K SÄ°STEMÄ° ---
    function verileriGetir() {
        database.ref('basvurular').on('value', snapshot => {
            const liste = document.getElementById('basvuruListesi');
            liste.innerHTML = "";
            basvuruVerileri = {};
            
            let [toplam, bekleyen, onay, red] = [0, 0, 0, 0];

            snapshot.forEach(child => {
                const data = child.val();
                const key = child.key;
                basvuruVerileri[key] = data;
                
                // Ä°statistik
                toplam++;
                if(data.durum === 'Beklemede') bekleyen++;
                else if(data.durum === 'OnaylandÄ±') onay++;
                else if(data.durum === 'Reddedildi') red++;

                // Tablo
                let renk = data.durum==='OnaylandÄ±'?'#10b981':(data.durum==='Reddedildi'?'#ef4444':'#f59e0b');
                let tarih = data.tarih ? new Date(data.tarih).toLocaleDateString('tr-TR') : '-';
                
                liste.innerHTML += `
                <tr>
                    <td><div onclick="discordKopyala('${data.discord_id}')" class="discord-link"><i class="fab fa-discord"></i> ${data.discord_id}</div></td>
                    <td>${data.ic_isim}</td>
                    <td style="color:${renk}; font-weight:bold;">${data.durum}</td>
                    <td><small>${tarih}</small></td>
                    <td>
                        <button onclick="detayAc('${key}')" class="btn btn-blue"><i class="fas fa-eye"></i></button>
                        <button onclick="onayla('${key}')" class="btn btn-green"><i class="fas fa-check"></i></button>
                        <button onclick="reddet('${key}')" class="btn btn-red"><i class="fas fa-times"></i></button>
                        <button onclick="dbSil('basvurular/${key}')" class="btn btn-dark"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });

            // Ä°statistikleri GÃ¼ncelle
            document.getElementById('statToplam').innerText = toplam;
            document.getElementById('statBekleyen').innerText = bekleyen;
            document.getElementById('statOnay').innerText = onay;
            document.getElementById('statRed').innerText = red;
        });
    }

    // --- KARA LÄ°STE ---
    function yasakla() {
        const id = document.getElementById('yasakliID').value.trim();
        const sebep = document.getElementById('yasakSebep').value.trim();
        if(id) {
            database.ref('blacklist').push({ discord_id: id, sebep: sebep });
            logKaydet("Yasaklama", `${id} kara listeye eklendi.`);
            alert("YasaklandÄ±.");
            document.getElementById('yasakliID').value = "";
        }
    }
    function blacklistGetir() {
        database.ref('blacklist').on('value', snapshot => {
            const liste = document.getElementById('blacklistListesi');
            liste.innerHTML = "";
            snapshot.forEach(child => {
                liste.innerHTML += `<tr><td>${child.val().discord_id}</td><td>${child.val().sebep}</td><td><button onclick="dbSil('blacklist/${child.key}')" class="btn btn-red">Sil</button></td></tr>`;
            });
        });
    }

    // --- EXCEL Ä°NDÄ°RME ---
    function excelIndir() {
        let html = document.getElementById("basvuruListesi").outerHTML;
        let blob = new Blob(["\ufeff", "<table>" + html + "</table>"], { type: "application/vnd.ms-excel" });
        let url = URL.createObjectURL(blob);
        let a = document.createElement("a");
        a.href = url;
        a.download = "basvurular_egm.xls";
        a.click();
        logKaydet("Excel", "BaÅŸvuru listesi indirildi.");
    }

    // --- STANDART FONKSÄ°YONLAR ---
    function onayla(key) {
        if(confirm("OnaylansÄ±n mÄ±?")) {
            database.ref('basvurular/'+key).update({durum: 'OnaylandÄ±'});
            logKaydet("Onay", `BaÅŸvuru onaylandÄ±. (ID: ${basvuruVerileri[key].discord_id})`);
            discordLog(key, "ONAYLANDI âœ…", 0x10b981);
        }
    }
    function reddet(key) {
        let sebep = prompt("Sebep:");
        if(sebep) {
            database.ref('basvurular/'+key).update({durum: 'Reddedildi', red_sebebi: sebep});
            logKaydet("Red", `BaÅŸvuru reddedildi. Sebep: ${sebep}`);
            discordLog(key, "REDDEDÄ°LDÄ° âŒ", 0xef4444, sebep);
        }
    }
    function discordLog(key, durum, renk, sebep="") {
        const url = localStorage.getItem('discordWebhook'); if(!url) return;
        const d = basvuruVerileri[key];
        const payload = { embeds: [{ title: `BaÅŸvuru: ${durum}`, color: renk, fields: [{name:"Ä°sim", value:d.ic_isim}, {name:"ID", value:d.discord_id}, {name:"Not", value:sebep || "-"}] }] };
        fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    }
    
    // YardÄ±mcÄ±lar
    function discordKopyala(text) { navigator.clipboard.writeText(text); alert("ID KopyalandÄ±: "+text); }
    function tabloAra(inputId, tableId) {
        let val = document.getElementById(inputId).value.toLowerCase();
        document.querySelectorAll('#'+tableId+' tr').forEach(r => {
            r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none';
        });
    }
    function webhookKaydet() { localStorage.setItem('discordWebhook', document.getElementById('webhookUrl').value); }
    function tabDegistir(id, el) { 
        document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active-tab'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active-tab');
    }
    function detayAc(key) {
        const data = basvuruVerileri[key];
        let html = "";
        if(data.cevaplar) {
            for(let [k,v] of Object.entries(data.cevaplar)) {
                let soru = (data.soru_detaylari && data.soru_detaylari[k]) ? data.soru_detaylari[k] : k;
                html += `<div style="margin-bottom:15px; border-bottom:1px solid #ccc; padding-bottom:5px;"><b style="color:#3b82f6;">${soru}</b><br>${v}</div>`;
            }
        }
        document.getElementById('modalIcerik').innerHTML = html;
        document.getElementById('detayModal').style.display = 'block';
    }
    function modalKapat() { document.getElementById('detayModal').style.display = 'none'; }
    function dbSil(yol) { 
        if(confirm("Silmek istediÄŸine emin misin?")) {
            database.ref(yol).remove();
            logKaydet("Silme", `${yol} silindi.`);
        }
    }

    // Telsiz & Chat
    function telsizDurumDegistir() {
        const btn = document.getElementById('btnConnectRadio');
        const cont = document.getElementById('jitsi-embed-container');
        if(jitsiApi) { jitsiApi.dispose(); jitsiApi=null; btn.innerText="BAÄžLAN"; btn.classList.remove('btn-green'); btn.classList.add('btn-red'); cont.innerHTML=""; }
        else {
            btn.innerText="AYRIL"; btn.classList.remove('btn-red'); btn.classList.add('btn-green');
            jitsiApi = new JitsiMeetExternalAPI("meet.jit.si", {
                roomName: "EGM_Ozel_Kanal_2024", width: "100%", height: "100%", parentNode: cont,
                configOverwrite: { startWithAudioMuted: false, startWithVideoMuted: true, prejoinPageEnabled: false },
                userInfo: { displayName: aktifKullanici }
            });
        }
    }
    function chatBaslat() {
        database.ref('chat').limitToLast(50).on('child_added', s => {
            const d = s.val();
            let div = document.getElementById('chatMessages');
            let cls = d.gonderen===aktifKullanici ? 'msg-mine' : 'msg-other';
            div.innerHTML += `<div class="message ${cls}"><b>${d.gonderen}:</b> ${d.mesaj}</div>`;
            div.scrollTop = div.scrollHeight;
            if(d.gonderen!==aktifKullanici) bildirimSesi.play().catch(e=>{});
        });
    }
    function mesajGonder() {
        let inp = document.getElementById('chatInput');
        if(inp.value.trim()) { database.ref('chat').push({gonderen:aktifKullanici, mesaj:inp.value.trim(), zaman:firebase.database.ServerValue.TIMESTAMP}); inp.value=""; }
    }
    function enterBas(e) { if(e.key==='Enter') mesajGonder(); }

    // Personel YÃ¶netimi
    function yoneticileriGetir() {
        database.ref('yetkililer').on('value', s => {
            const l = document.getElementById('yoneticiListesi'); l.innerHTML="";
            s.forEach(c => {
                let d = c.val();
                let sil = (aktifKullanici==='MÃ¼dÃ¼r' && d.kadi!=='MÃ¼dÃ¼r') ? `<button onclick="dbSil('yetkililer/${c.key}')" class="btn btn-red">Sil</button>` : 'ðŸ”’';
                l.innerHTML += `<tr><td>${d.kadi}</td><td>${d.kadi==='MÃ¼dÃ¼r'?'YÃ¶netici':'Memur'}</td><td>${sil}</td></tr>`;
            });
        });
    }
    function yetkiliEkle() {
        if(aktifKullanici!=='MÃ¼dÃ¼r') return alert("Sadece MÃ¼dÃ¼r personel ekleyebilir.");
        let k = document.getElementById('yeniKadi').value;
        let s = document.getElementById('yeniSifre').value;
        if(k&&s) { database.ref('yetkililer').push({kadi:k, sifre:s}); logKaydet("Personel Ekleme", `${k} eklendi.`); alert("Eklendi."); }
    }
</script>
</body>
</html>
