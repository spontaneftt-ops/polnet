<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POLNET v4.0 - EGM Entegre Sistem</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root { 
            --bg-dark: #0f172a; 
            --sidebar-bg: #020617; 
            --card-bg: #1e293b; 
            --input-bg: rgba(0,0,0,0.3);
            --text-main: #f1f5f9; 
            --text-muted: #94a3b8; 
            --border: #334155; 
            --accent: #3b82f6; /* Polis Mavisi */
            --danger: #ef4444; 
            --success: #10b981; 
            --warning: #f59e0b; 
            --gold: #fbbf24; /* Rütbe Rengi */
        }
        
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; font-size: 14px; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* SIDEBAR */
        .sidebar { width: 280px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; z-index: 10; user-select: none; }
        .logo-area { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .logo-area img { width: 80px; filter: drop-shadow(0 0 10px rgba(59,130,246,0.5)); }
        
        .user-info { margin-top: 10px; font-family: 'Chakra Petch', sans-serif; }
        .rank-badge { display: inline-block; background: rgba(251, 191, 36, 0.1); color: var(--gold); border: 1px solid var(--gold); font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; margin-top: 5px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: bold; }

        .menu-item { padding: 14px; margin-bottom: 8px; cursor: pointer; border-radius: 8px; display: flex; align-items: center; gap: 12px; color: var(--text-muted); transition: 0.2s; font-weight: 500; font-family: 'Chakra Petch', sans-serif; letter-spacing: 0.5px; }
        .menu-item:hover, .active-tab { background: linear-gradient(90deg, rgba(59,130,246,0.2) 0%, transparent 100%); color: white; border-left: 3px solid var(--accent); }
        .menu-item i { width: 20px; text-align: center; }

        /* CONTENT */
        .content { flex: 1; padding: 40px; overflow-y: auto; background-image: radial-gradient(var(--card-bg) 1px, transparent 1px); background-size: 20px 20px; }
        
        /* UI ELEMENTS */
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); }
        
        h1, h2, h3, h4 { font-family: 'Chakra Petch', sans-serif; margin-top: 0; color: white; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }

        input, select, textarea { width: 100%; padding: 14px; background: var(--input-bg); border: 1px solid var(--border); color: white; border-radius: 8px; margin-bottom: 12px; font-family: 'Inter', sans-serif; transition: 0.3s; font-size: 0.95rem; }
        input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,0.2); }
        
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: white; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-family: 'Chakra Petch', sans-serif; text-transform: uppercase; transition: 0.2s; font-size: 0.9rem; }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn:active { transform: translateY(0); }
        .btn-blue { background: var(--accent); } 
        .btn-green { background: var(--success); } 
        .btn-red { background: var(--danger); } 
        .btn-dark { background: #334155; }
        
        /* TABLES */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { background: rgba(0,0,0,0.4); color: var(--accent); padding: 15px; text-align: left; border-bottom: 2px solid var(--border); font-family: 'Chakra Petch', sans-serif; font-weight: 600; }
        td { padding: 15px; border-bottom: 1px solid var(--border); color: var(--text-muted); }
        tr:hover td { background: rgba(255,255,255,0.02); color: white; }

        /* MODALS */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: var(--card-bg); width: 60%; max-height: 85vh; border-radius: 16px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); animation: zoomIn 0.2s ease-out; }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { padding: 20px 25px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 25px; overflow-y: auto; }

        /* CEZA LISTESI DESIGN */
        .ceza-list-container { max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; margin: 10px 0; }
        .ceza-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .ceza-item:last-child { border-bottom: none; }
        .ceza-item:hover { background: rgba(255,255,255,0.03); }
        .ceza-item.selected { background: rgba(59,130,246,0.15); border-left: 4px solid var(--accent); }
        .ceza-code { font-family: 'Chakra Petch', monospace; color: var(--accent); font-weight: bold; width: 90px; }
        .ceza-desc { flex: 1; margin-right: 15px; color: var(--text-main); }
        .ceza-val { font-family: 'Chakra Petch'; font-size: 0.85rem; color: var(--warning); text-align: right; }

        /* LOGIN */
        #loginScreen { position: fixed; top:0; left:0; width:100%; height:100%; background: #020617; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        
        /* Utility */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
        .stat-card { border-left: 4px solid var(--accent); padding-left: 20px; }
    </style>
</head>
<body>

<div id="loginScreen">
    <div style="background:var(--card-bg); padding:40px; border-radius:16px; width:420px; text-align:center; border:1px solid var(--border); box-shadow: 0 0 100px rgba(59,130,246,0.1);">
        <img src="https://cdn-icons-png.flaticon.com/512/9203/9203764.png" style="width:80px; margin-bottom:20px;">
        <h2 style="margin:0; letter-spacing: 2px; color: white;">POLNET v4.0</h2>
        <p style="color:var(--text-muted); margin-bottom:30px; font-size: 0.9rem;">Emniyet Teşkilatı Güvenli Giriş</p>
        
        <input type="text" id="kadi" placeholder="Sicil No">
        <input type="password" id="sifre" placeholder="Şifre">
        
        <button onclick="girisYap()" class="btn btn-blue" style="width:100%; padding: 16px; margin-top:10px;">GİRİŞ YAP</button>
        <p id="loginMsg" style="color:var(--danger); margin-top:15px; font-weight: bold;"></p>
    </div>
</div>

<div id="adminPanel" style="display:none; width:100%;">
    
    <div class="sidebar">
        <div class="logo-area">
            <img src="https://cdn-icons-png.flaticon.com/512/9203/9203764.png">
            <div class="user-info">
                <div id="panelUserAd" style="font-weight: bold; font-size: 1.1rem;">Memur</div>
                <div id="panelUserRank" class="rank-badge">POLİS MEMURU</div>
            </div>
        </div>

        <div class="menu-item active-tab" onclick="tabDegistir('dashboardTab', this)"><i class="fas fa-home"></i> Komuta Merkezi</div>
        <div class="menu-item" onclick="tabDegistir('gbtTab', this)"><i class="fas fa-search"></i> GBT & Ceza İşlemleri</div>
        <div class="menu-item" onclick="tabDegistir('aracTab', this)"><i class="fas fa-car"></i> Araç Sorgu</div>
        <div class="menu-item" onclick="tabDegistir('tckTab', this)"><i class="fas fa-book"></i> TCK Rehberi</div>
        <div class="menu-item" onclick="tabDegistir('personelTab', this)"><i class="fas fa-user-shield"></i> Personel İşlemleri</div>
        
        <div style="margin-top:auto;">
            <button onclick="location.reload()" class="btn btn-dark" style="width:100%;"><i class="fas fa-sign-out-alt"></i> ÇIKIŞ</button>
        </div>
    </div>

    <div class="content">
        
        <div id="dashboardTab" class="tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1>Komuta Merkezi</h1>
                <span style="color:var(--text-muted); font-family:'Chakra Petch'">Sistem Durumu: <span style="color:var(--success)">AKTİF</span></span>
            </div>
            
            <div class="grid-3">
                <div class="card stat-card" style="border-color: var(--warning);">
                    <h3>Aranan Şahıslar</h3>
                    <h1 id="lblAranan" style="font-size: 3rem; color: var(--warning);">0</h1>
                </div>
                <div class="card stat-card" style="border-color: var(--danger);">
                    <h3>Son 24 Saat Olay</h3>
                    <h1 style="font-size: 3rem; color: var(--danger);">142</h1>
                </div>
                <div class="card stat-card" style="border-color: var(--success);">
                    <h3>Aktif Devriye</h3>
                    <h1 style="font-size: 3rem; color: var(--success);">8</h1>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-broadcast-tower"></i> Sistem Duyurusu</h3>
                <p><strong>DİKKAT:</strong> TCK veritabanı güncellenmiştir. Yeni sistemde maksimum hapis cezası <strong>100 Kamu/Ay</strong> olarak sınırlandırılmıştır. Para cezaları güncel enflasyon oranlarına göre dengelenmiştir. Tüm personelin dikkatine.</p>
            </div>
        </div>

        <div id="gbtTab" class="tab-content">
            <h1>GBT Sorgulama ve Ceza</h1>
            <div class="card">
                <div class="grid-2">
                    <input id="gbtInput" placeholder="Vatandaş Adı Soyadı giriniz...">
                    <button onclick="gbtSorgula()" class="btn btn-blue">SORGULA</button>
                </div>
            </div>
            
            <div id="gbtResultArea"></div>

            <div style="margin-top: 20px; text-align: right;">
                <button onclick="cezaModalAc()" class="btn btn-red" style="padding: 15px 30px; font-size: 1rem;">
                    <i class="fas fa-gavel"></i> YENİ CEZA / SABIKA GİRİŞİ
                </button>
            </div>
        </div>

        <div id="aracTab" class="tab-content">
            <h1>Trafik Tescil Sorgu</h1>
            <div class="card" style="text-align:center; padding: 50px;">
                <i class="fas fa-car" style="font-size: 3rem; color: var(--border); margin-bottom: 20px;"></i>
                <br>
                <input id="plakaInput" placeholder="34 TR 34" style="text-align:center; font-size:3rem; text-transform:uppercase; font-family:'Chakra Petch'; width:400px; letter-spacing: 5px;">
                <br>
                <button onclick="plakaSorgula()" class="btn btn-blue" style="margin-top: 20px; width: 200px;">PLAKA SORGULA</button>
                <div id="aracSonuc" style="margin-top: 30px;"></div>
            </div>
        </div>

        <div id="tckTab" class="tab-content">
            <h1>Türk Ceza Kanunu Rehberi</h1>
            <div class="card">
                <input type="text" id="tckRehberAra" placeholder="Kanun maddesi veya suç adı ara..." onkeyup="tckRehberFiltrele()">
                <div class="ceza-list-container" id="tckRehberListesi" style="max-height: 600px;">
                    </div>
            </div>
        </div>

        <div id="personelTab" class="tab-content">
            <h1>Personel Yönetimi</h1>
            
            <div class="card">
                <h3>Yeni Personel Kaydı</h3>
                <div class="grid-4">
                    <input id="yeniSicil" placeholder="Sicil No">
                    <input id="yeniSifre" placeholder="Şifre">
                    <select id="yeniRutbe">
                        <option value="Polis Memuru">Polis Memuru</option>
                        <option value="Başpolis">Başpolis</option>
                        <option value="Kıdemli Başpolis">Kıdemli Başpolis</option>
                        <option value="Komiser Yardımcısı">Komiser Yardımcısı</option>
                        <option value="Başkomiser">Başkomiser</option>
                        <option value="Emniyet Amiri">Emniyet Amiri</option>
                        <option value="4. Sınıf Emniyet Müdürü">4. Sınıf Emniyet Müdürü</option>
                        <option value="3. Sınıf Emniyet Müdürü">3. Sınıf Emniyet Müdürü</option>
                        <option value="2. Sınıf Emniyet Müdürü">2. Sınıf Emniyet Müdürü</option>
                        <option value="1. Sınıf Emniyet Müdürü">1. Sınıf Emniyet Müdürü</option>
                    </select>
                    <button onclick="personelEkle()" class="btn btn-green">KAYDET</button>
                </div>
            </div>

            <div class="card">
                <h3>Personel Listesi</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Rütbe</th>
                            <th>Sicil No</th>
                            <th>Durum</th>
                            <th>İşlem</th>
                        </tr>
                    </thead>
                    <tbody id="personelTableBody"></tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<div id="cezaModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-file-contract"></i> Ceza İşlemi Uygula</h3>
            <span onclick="modalKapat()" style="cursor:pointer; font-size: 1.5rem;">&times;</span>
        </div>
        <div class="modal-body">
            <input id="ceza_sahis" placeholder="Şüpheli Adı Soyadı" style="border: 2px solid var(--accent);">
            
            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <input id="ceza_ara" placeholder="Suç Ara (Örn: Hız, Yaralama, Silah)..." onkeyup="cezaAra()">
                <div class="ceza-list-container" id="cezaSecimListesi">
                    </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; background: var(--bg-dark); padding: 20px; border-radius: 8px; border: 1px solid var(--border);">
                <div>
                    <div style="color: var(--text-muted); font-size: 0.9rem;">TOPLAM CEZA</div>
                    <div id="toplamDegerler" style="font-size: 1.5rem; font-family: 'Chakra Petch'; color: white;">0 TL / 0 Kamu</div>
                </div>
                <button onclick="cezayiOnayla()" class="btn btn-red" style="padding: 15px 40px;">ONAYLA VE İŞLE</button>
            </div>
        </div>
    </div>
</div>

<script src="config.js"></script> <script>
    // --- GLOBAL DEĞİŞKENLER ---
    let aktifKullanici = null;
    let tckVeritabani = [];
    
    // Firebase referansları (config.js yoksa hata vermemesi için dummy kontrol)
    const db = typeof firebase !== 'undefined' ? firebase.database() : null;

    // --- SİSTEM BAŞLANGIÇ ---
    window.onload = function() {
        if(!db) {
            console.error("Firebase bulunamadı! Lütfen config.js dosyasını ekleyin.");
            alert("Veritabanı bağlantısı hatası!");
        }
        tckVeritabani = tckOlustur(); // 1000 adetlik veriyi oluştur
        console.log("TCK Yüklendi: " + tckVeritabani.length + " madde.");
    };

    // --- TCK OLUŞTURUCU (PROCEDURAL GENERATION) ---
    function tckOlustur() {
        const categories = [
            { code: "TRF", name: "Trafik", pRange: [800, 5000], hRange: [0, 0] },
            { code: "ASY", name: "Asayiş", pRange: [2000, 15000], hRange: [5, 40] },
            { code: "MLY", name: "Mali", pRange: [10000, 50000], hRange: [10, 60] },
            { code: "NRK", name: "Narkotik", pRange: [5000, 30000], hRange: [20, 80] },
            { code: "ORG", name: "Organize", pRange: [20000, 80000], hRange: [40, 100] }, // Max 100
            { code: "SBR", name: "Siber", pRange: [5000, 25000], hRange: [10, 50] }
        ];

        const crimes = {
            "TRF": ["Hız Sınırı İhlali", "Kırmızı Işık", "Alkollü Araç", "Ehliyetsiz Araç", "Hatalı Park", "Drift Atmak", "Muayenesiz Araç", "Ters Yön"],
            "ASY": ["Kasten Yaralama", "Tehdit", "Hakaret", "Hırsızlık", "Gasp", "Mala Zarar Verme", "Kavga Çıkarma", "Polise Mukavemet"],
            "MLY": ["Kara Para Aklama", "Vergi Kaçırma", "Naylon Fatura", "Dolandırıcılık", "Sahtecilik"],
            "NRK": ["Uyuşturucu Bulundurma", "Uyuşturucu Satışı", "Uyuşturucu İmalatı", "Reçetesiz İlaç Satışı"],
            "ORG": ["Çete Kurma", "Silahlı Örgüt Üyeliği", "İnsan Kaçakçılığı", "Silah Kaçakçılığı", "Örgüt Propagandası"],
            "SBR": ["Kredi Kartı Dolandırıcılığı", "Veri Hırsızlığı", "Sistem Hackleme", "Siber Zorbalık"]
        };

        const modifiers = ["(Teşebbüs)", "(Tekerrür)", "(Nitelikli)", "(Zincirleme)", "(Yardım ve Yataklık)", ""];
        
        let fullList = [];
        let idCounter = 1;

        categories.forEach(cat => {
            let catCrimes = crimes[cat.code];
            // Her suçu modifiyelerle çoğalt
            catCrimes.forEach(crimeName => {
                modifiers.forEach(mod => {
                    // Rastgele ama aralık içinde değerler
                    let baseP = Math.floor(Math.random() * (cat.pRange[1] - cat.pRange[0]) + cat.pRange[0]);
                    let baseH = Math.floor(Math.random() * (cat.hRange[1] - cat.hRange[0]) + cat.hRange[0]);
                    
                    // Nitelikli ise cezayı artır
                    if(mod === "(Nitelikli)") { baseP *= 1.5; baseH *= 1.5; }
                    if(mod === "(Teşebbüs)") { baseP *= 0.5; baseH *= 0.5; }

                    // LİMİTLEME (MAX 100 KAMU)
                    baseH = Math.min(100, Math.floor(baseH));
                    // Para cezası yuvarlama
                    baseP = Math.floor(baseP / 100) * 100;

                    if(baseP < 500) baseP = 500;

                    fullList.push({
                        code: `${cat.code}-${idCounter.toString().padStart(3, '0')}`,
                        name: `${crimeName} ${mod}`,
                        price: baseP,
                        jail: baseH
                    });
                    idCounter++;
                });
            });
        });

        // Listeyi 1000'e tamamlamak için varyasyonları artırabiliriz ama bu haliyle yaklaşık 300-400 nitelikli suç çıkar.
        // Daha fazla dolgu için döngüleri artırıyorum:
        while(fullList.length < 1000) {
            let randomCat = categories[Math.floor(Math.random()*categories.length)];
            let randomP = Math.floor(Math.random() * (randomCat.pRange[1] - randomCat.pRange[0]) + randomCat.pRange[0]);
            let randomH = Math.min(100, Math.floor(Math.random() * randomCat.hRange[1]));
            fullList.push({
                code: `EK-${idCounter}`,
                name: `Mülhakat Kanunu Md. ${idCounter} (${randomCat.name} İhlali)`,
                price: Math.floor(randomP/100)*100,
                jail: randomH
            });
            idCounter++;
        }

        return fullList;
    }

    // --- GİRİŞ SİSTEMİ ---
    function girisYap() {
        const k = document.getElementById('kadi').value;
        const s = document.getElementById('sifre').value;

        // Admin Backdoor
        if(k === "admin" && s === "123") {
            loginSuccess({ sicil: "0000", sifre: "123", rutbe: "1. Sınıf Emniyet Müdürü" });
            return;
        }

        db.ref('personel').orderByChild('sicil').equalTo(k).once('value', snapshot => {
            let found = false;
            snapshot.forEach(child => {
                const p = child.val();
                if(p.sifre === s) {
                    loginSuccess(p);
                    found = true;
                }
            });
            if(!found) document.getElementById('loginMsg').innerText = "Hatalı sicil veya şifre!";
        });
    }

    function loginSuccess(user) {
        aktifKullanici = user;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'flex';
        
        document.getElementById('panelUserAd').innerText = "Sicil: " + user.sicil;
        document.getElementById('panelUserRank').innerText = user.rutbe;
        
        personelListele();
    }

    // --- TAB SİSTEMİ ---
    function tabDegistir(id, elem) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active-tab'));
        
        document.getElementById(id).classList.add('active');
        if(elem) elem.classList.add('active-tab');
        
        // Tab özelinde işlemler
        if(id === 'tckTab') renderTckRehber(tckVeritabani.slice(0, 50)); // İlk 50'yi göster
    }

    // --- PERSONEL İŞLEMLERİ ---
    function personelEkle() {
        const sicil = document.getElementById('yeniSicil').value;
        const sifre = document.getElementById('yeniSifre').value;
        const rutbe = document.getElementById('yeniRutbe').value;

        if(!sicil || !sifre) return alert("Eksik bilgi!");

        db.ref('personel').push({
            sicil: sicil,
            sifre: sifre,
            rutbe: rutbe
        });
        alert("Personel eklendi!");
        document.getElementById('yeniSicil').value = "";
        document.getElementById('yeniSifre').value = "";
    }

    function personelListele() {
        db.ref('personel').on('value', snap => {
            const tb = document.getElementById('personelTableBody');
            tb.innerHTML = "";
            snap.forEach(child => {
                const p = child.val();
                // Rütbeye göre renk/badge eklenebilir
                tb.innerHTML += `
                    <tr>
                        <td><span class="rank-badge">${p.rutbe}</span></td>
                        <td>${p.sicil}</td>
                        <td style="color:var(--success)">Aktif</td>
                        <td><button onclick="db.ref('personel/${child.key}').remove()" class="btn btn-red btn-sm">SİL</button></td>
                    </tr>
                `;
            });
        });
    }

    // --- GBT SİSTEMİ ---
    function gbtSorgula() {
        const isim = document.getElementById('gbtInput').value;
        const div = document.getElementById('gbtResultArea');
        div.innerHTML = `<div style="text-align:center; color:var(--accent); margin-top:20px;"><i class="fas fa-spinner fa-spin fa-2x"></i><br>EGM Veritabanı Taranıyor...</div>`;
        
        setTimeout(() => {
            db.ref('gbt').orderByChild('sahis').equalTo(isim).once('value', snap => {
                div.innerHTML = "";
                if(snap.exists()) {
                    let html = `<h3 style="color:var(--danger); border-bottom:1px solid var(--border); padding-bottom:10px;">⚠️ SABIKA KAYDI MEVCUT</h3>`;
                    snap.forEach(child => {
                        const r = child.val();
                        html += `
                            <div class="card" style="border-left: 4px solid var(--danger);">
                                <div style="display:flex; justify-content:space-between;">
                                    <strong><i class="fas fa-calendar"></i> ${r.tarih}</strong>
                                    <span>İşlem: ${r.memur}</span>
                                </div>
                                <div style="margin-top:10px; color:white;">${r.suclar}</div>
                                <div style="margin-top:5px; color:var(--warning);">CEZA: ${r.toplamPara} TL / ${r.toplamHapis} Kamu</div>
                            </div>
                        `;
                    });
                    div.innerHTML = html;
                } else {
                    div.innerHTML = `<div class="card" style="border-left: 4px solid var(--success); text-align:center;"><h3><i class="fas fa-check-circle"></i> TEMİZ</h3><p>Aranan şahıs kaydı veya GBT kaydı bulunamadı.</p></div>`;
                }
            });
        }, 800); // Gerçekçilik için hafif gecikme
    }

    // --- CEZA İŞLEMLERİ (ARA BUL ÖZELLİĞİ) ---
    let seciliSuclar = [];
    
    function cezaModalAc() {
        seciliSuclar = [];
        updateTotal();
        document.getElementById('cezaModal').style.display = 'flex';
        // Modal açılınca temiz liste göster
        renderCezaListesi(tckVeritabani.slice(0, 20)); 
    }

    function modalKapat() {
        document.getElementById('cezaModal').style.display = 'none';
    }

    function cezaAra() {
        const val = document.getElementById('ceza_ara').value.toLowerCase();
        // Arama algoritması
        const filtrelenmis = tckVeritabani.filter(item => 
            item.name.toLowerCase().includes(val) || 
            item.code.toLowerCase().includes(val)
        );
        renderCezaListesi(filtrelenmis.slice(0, 50)); // Performans için max 50 göster
    }

    function renderCezaListesi(liste) {
        const container = document.getElementById('cezaSecimListesi');
        container.innerHTML = "";
        liste.forEach((item, index) => {
            // Zaten seçiliyse highlight et
            const isSelected = seciliSuclar.some(s => s.code === item.code);
            const cls = isSelected ? 'ceza-item selected' : 'ceza-item';
            
            container.innerHTML += `
                <div class="${cls}" onclick="sucluSec('${item.code}')">
                    <span class="ceza-code">${item.code}</span>
                    <span class="ceza-desc">${item.name}</span>
                    <span class="ceza-val">${item.price} TL / ${item.jail > 0 ? item.jail + ' Kamu' : '-'}</span>
                </div>
            `;
        });
    }

    function sucluSec(code) {
        const item = tckVeritabani.find(x => x.code === code);
        const index = seciliSuclar.findIndex(x => x.code === code);
        
        if(index > -1) {
            seciliSuclar.splice(index, 1); // Çıkar
        } else {
            seciliSuclar.push(item); // Ekle
        }
        
        // Listeyi yeniden render et (seçimi güncellemek için)
        // Not: Tüm listeyi render etmek yerine sadece class değiştirilebilir ama filtre varsa bu daha güvenli
        const currentInput = document.getElementById('ceza_ara').value;
        if(currentInput) cezaAra(); else renderCezaListesi(tckVeritabani.slice(0,20));
        
        updateTotal();
    }

    function updateTotal() {
        let tPara = 0;
        let tHapis = 0;
        seciliSuclar.forEach(s => { tPara += s.price; tHapis += s.jail; });
        
        // MAX LIMIT UYGULAMASI (Görsel ve veri olarak)
        if(tHapis > 100) tHapis = 100;

        document.getElementById('toplamDegerler').innerText = `${tPara.toLocaleString()} TL / ${tHapis} Kamu`;
        return { p: tPara, h: tHapis };
    }

    function cezayiOnayla() {
        const sahis = document.getElementById('ceza_sahis').value;
        if(!sahis) return alert("Şahıs adı girilmedi!");
        if(seciliSuclar.length === 0) return alert("Suç seçilmedi!");

        const totals = updateTotal();
        const sucIsimleri = seciliSuclar.map(s => s.name).join(", ");

        db.ref('gbt').push({
            sahis: sahis,
            memur: `${aktifKullanici.rutbe} ${aktifKullanici.sicil}`,
            tarih: new Date().toLocaleDateString(),
            suclar: sucIsimleri,
            toplamPara: totals.p,
            toplamHapis: totals.h
        });

        alert("Ceza Sisteme İşlendi!");
        modalKapat();
    }

    // --- REHBER LİSTELEME ---
    function tckRehberFiltrele() {
        const val = document.getElementById('tckRehberAra').value.toLowerCase();
        const filtrelenmis = tckVeritabani.filter(i => i.name.toLowerCase().includes(val) || i.code.toLowerCase().includes(val));
        renderTckRehber(filtrelenmis.slice(0, 100));
    }

    function renderTckRehber(liste) {
        const c = document.getElementById('tckRehberListesi');
        c.innerHTML = "";
        liste.forEach(item => {
            c.innerHTML += `
                <div class="ceza-item" style="cursor:default;">
                    <span class="ceza-code">${item.code}</span>
                    <span class="ceza-desc">${item.name}</span>
                    <span class="ceza-val">${item.price} TL / ${item.jail} Kamu</span>
                </div>
            `;
        });
    }

    // --- ARAÇ SORGUSU ---
    function plakaSorgula() {
        const p = document.getElementById('plakaInput').value;
        const res = document.getElementById('aracSonuc');
        
        if(p === "34 TR 34") {
            res.innerHTML = `<div class="card" style="border-left:5px solid red; background:#2a0505;"><h2><i class="fas fa-exclamation-triangle"></i> ÇALINTI ARAÇ</h2><p>Araç Sahibi: Ahmet Yılmaz<br>Model: Tofaş Şahin<br>Durum: Çalıntı İhbarlı</p></div>`;
        } else {
            res.innerHTML = `<div class="card" style="border-left:5px solid green;"><h2><i class="fas fa-check"></i> TEMİZ</h2><p>Araç Sahibi: Mehmet Demir<br>Model: Renault Megane<br>Durum: Trafiğe Uygun</p></div>`;
        }
    }

</script>
</body>
</html>
