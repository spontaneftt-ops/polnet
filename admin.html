<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>EGM Personel YÃ¶netim</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://meet.jit.si/external_api.js"></script>

    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; background: #162447; color: white; display: flex; flex-direction: column; padding: 20px; z-index: 2; }
        .content { flex: 1; padding: 40px; overflow-y: auto; background: #eef2f5; position: relative; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-top: 20px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #1f4068; color: white; }
        
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; margin-right: 5px; font-weight: bold; font-size: 0.9rem; transition: 0.2s; }
        .btn:hover { opacity: 0.8; }
        .btn-green { background: #28a745; } .btn-red { background: #dc3545; } .btn-blue { background: #007bff; } .btn-dark { background: #343a40; } .btn-yellow { background: #f1c40f; color: #333; }
        .discord-link { color: #5865F2; font-weight: bold; text-decoration: none; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 70%; max-width: 900px; border-radius: 10px; }
        .modal-header { padding: 20px; background-color: #162447; color: white; display: flex; justify-content: space-between; align-items: center; border-radius: 10px 10px 0 0; }
        .modal-body { padding: 30px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 15px; background-color: #eee; text-align: right; border-radius: 0 0 10px 10px; }
        .soru-item { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .soru-baslik { font-weight: bold; color: #162447; display: block; margin-bottom: 5px; font-size: 1.1rem; }
        .cevap-metni { color: #333; font-size: 1rem; white-space: pre-wrap; background: #f9f9f9; padding: 10px; border-radius: 5px; border-left: 4px solid #ffd700; }
        
        #loginScreen { position: fixed; top:0; left:0; width:100%; height:100%; background: #162447; z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 10px; width: 350px; text-align: center; }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .menu-item { padding: 15px; cursor: pointer; color: #ccc; } .menu-item:hover, .active-tab { color: white; background: rgba(255,255,255,0.1); border-radius: 5px; }
        .webhook-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; margin-top: 20px; font-size: 0.8rem; display: none; }
        .webhook-input { width: 100%; padding: 5px; margin-top: 5px; box-sizing: border-box; border: none; border-radius: 3px; }

        /* --- TELSÄ°Z ODASI STÄ°LLERÄ° --- */
        .radio-room-container { display: flex; height: 75vh; gap: 20px; }
        
        /* Sol Taraf: Telsiz KontrolÃ¼ */
        .radio-control { 
            width: 350px; background: #2c3e50; border-radius: 10px; display: flex; flex-direction: column; overflow: hidden; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .radio-header { background: #1a252f; padding: 15px; text-align: center; color: #bdc3c7; font-weight: bold; border-bottom: 2px solid #34495e; }
        
        /* BaÄŸlan Butonu */
        .connect-box { padding: 20px; text-align: center; background: #34495e; }
        .btn-radio-toggle { 
            padding: 15px 30px; font-size: 1.1rem; font-weight: bold; color: white; 
            background: #e74c3c; border: none; border-radius: 50px; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: 0.3s; width: 100%;
        }
        .btn-radio-toggle.connected { background: #27ae60; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(39, 174, 96, 0); } 100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); } }

        /* Jitsi AlanÄ± */
        #jitsi-embed-container { 
            flex: 1; background: #000; position: relative; min-height: 300px;
        }
        .jitsi-placeholder { 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            display: flex; justify-content: center; align-items: center; 
            color: #7f8c8d; font-size: 0.9rem; text-align: center; padding: 20px;
        }

        /* SaÄŸ Taraf: YazÄ±lÄ± Sohbet */
        .chat-area { flex: 1; background: white; border-radius: 10px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .chat-header { background: #162447; color: white; padding: 15px; font-weight: bold; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #ecf0f1; }
        .message { max-width: 80%; padding: 10px; border-radius: 8px; font-size: 0.95rem; line-height: 1.4; }
        .msg-mine { align-self: flex-end; background: #3498db; color: white; border-bottom-right-radius: 0; }
        .msg-other { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 0; border: 1px solid #ddd; }
        .msg-info { font-size: 0.7rem; opacity: 0.7; display: block; margin-bottom: 2px; font-weight: bold; }
        .chat-input-box { padding: 15px; background: white; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <h2 style="color:#162447;">YÃ–NETÄ°M PANELÄ°</h2>
        <input type="text" id="kadi" class="login-input" placeholder="KullanÄ±cÄ± AdÄ±">
        <input type="password" id="sifre" class="login-input" placeholder="Åifre">
        <button onclick="girisYap()" class="btn btn-blue" style="width:100%; padding:12px; margin-top:10px;">GiriÅŸ Yap</button>
        <p id="loginMsg" style="color:red; margin-top:10px;"></p>
    </div>
</div>

<div id="detayModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalBaslik" style="margin:0;">BaÅŸvuru DetayÄ±</h2>
            <span onclick="modalKapat()" style="cursor:pointer; font-size:24px;">&times;</span>
        </div>
        <div class="modal-body" id="modalIcerik"></div>
        <div class="modal-footer">
            <button onclick="modalKapat()" class="btn btn-red">Kapat</button>
        </div>
    </div>
</div>

<div id="adminPanel" style="display:none; width:100%;">
    <div class="sidebar">
        <h2 style="color:#ffd700; text-align:center;">MÃœDÃœRLÃœK</h2>
        <div class="menu-item active-tab" onclick="tabDegistir('basvurularTab', this)">ğŸ“„ BaÅŸvurular</div>
        <div class="menu-item" onclick="tabDegistir('yoneticilerTab', this)">ğŸ‘®â€â™‚ï¸ Personel</div>
        <div class="menu-item" onclick="tabDegistir('sohbetTab', this)">ğŸ™ï¸ Komuta & Telsiz</div>
        
        <div id="webhookAyarKutusu" class="webhook-box">
            <label>Discord Webhook URL:</label>
            <input type="password" id="webhookUrl" class="webhook-input" placeholder="Webhook URL..." onchange="webhookKaydet()">
        </div>

        <div class="menu-item" onclick="location.reload()" style="margin-top:auto; color:#e43f5a;">ğŸšª Ã‡Ä±kÄ±ÅŸ</div>
    </div>

    <div class="content">
        <div id="basvurularTab" class="tab-content active">
            <h2 style="color:#162447;">Gelen BaÅŸvurular</h2>
            <table>
                <thead><tr><th>Discord ID</th><th>IC Ä°sim</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead>
                <tbody id="basvuruListesi"></tbody>
            </table>
        </div>

        <div id="yoneticilerTab" class="tab-content">
            <h2 style="color:#162447;">Personel Listesi</h2>
            <div style="background:white; padding:20px; margin-bottom:20px;">
                <input type="text" id="yeniKadi" placeholder="KullanÄ±cÄ± AdÄ±" style="padding:8px;">
                <input type="password" id="yeniSifre" placeholder="Åifre" style="padding:8px;">
                <button onclick="yetkiliEkle()" class="btn btn-green">Ekle</button>
            </div>
            <table>
                <thead><tr><th>KullanÄ±cÄ±</th><th>Åifre</th><th>Ä°ÅŸlem</th></tr></thead>
                <tbody id="yoneticiListesi"></tbody>
            </table>
        </div>

        <div id="sohbetTab" class="tab-content">
            <h2 style="color:#162447;">Komuta Kontrol & Telsiz</h2>
            
            <div class="radio-room-container">
                <div class="radio-control">
                    <div class="radio-header">ğŸ”Š EGM TELSÄ°Z HATTI</div>
                    
                    <div class="connect-box">
                        <button id="btnConnectRadio" onclick="telsizDurumDegistir()" class="btn-radio-toggle">ğŸ”´ TELSÄ°Z KAPALI</button>
                    </div>

                    <div id="jitsi-embed-container">
                        <div class="jitsi-placeholder">
                            Telsize baÄŸlanmak iÃ§in yukarÄ±daki butona basÄ±nÄ±z.<br><br>
                            Mikrofon izni vermeyi unutmayÄ±n.
                        </div>
                    </div>
                </div>

                <div class="chat-area">
                    <div class="chat-header">ğŸ’¬ YazÄ±lÄ± Kanal</div>
                    <div class="chat-messages" id="chatMessages">
                        </div>
                    <div class="chat-input-box">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Mesaj yaz..." onkeydown="enterBas(event)">
                        <button onclick="mesajGonder()" class="btn btn-blue">GÃ–NDER</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="config.js"></script>
<script>
    const yedekSozluk = {"discord_id": "Discord ID", "ic_isim": "IC Ä°sim Soyisim", "ooc_yas": "OOC YaÅŸ", "aktiflik": "GÃ¼nlÃ¼k Aktiflik", "karakter_hikaye": "Karakter Hikayesi", "deneyim": "FiveM Deneyimi"};
    let basvuruVerileri = {};
    let aktifKullanici = "";
    let jitsiApi = null; 

    window.onload = function() {
        const kayitliWebhook = localStorage.getItem('discordWebhook');
        if(kayitliWebhook) document.getElementById('webhookUrl').value = kayitliWebhook;
    }

    function webhookKaydet() {
        const url = document.getElementById('webhookUrl').value;
        localStorage.setItem('discordWebhook', url);
    }

    function girisYap() {
        const kadi = document.getElementById('kadi').value.trim();
        const sifre = document.getElementById('sifre').value.trim();
        
        if (kadi === "MÃ¼dÃ¼r" && sifre === "GÃ¶kSancak1881") { 
            basariliGiris("MÃ¼dÃ¼r");
            database.ref('yetkililer').orderByChild('kadi').equalTo('MÃ¼dÃ¼r').once('value', s => { 
                if(!s.exists()) database.ref('yetkililer').push({kadi: 'MÃ¼dÃ¼r', sifre: 'GÃ¶kSancak1881'}); 
            }); 
            return; 
        }

        database.ref('yetkililer').orderByChild('kadi').equalTo(kadi).once('value', snapshot => { 
            let ok = false; 
            snapshot.forEach(c => { if(c.val().sifre === sifre) ok = true; }); 
            if(ok) { basariliGiris(kadi); } 
            else { document.getElementById('loginMsg').innerText = "HatalÄ± GiriÅŸ!"; }
        });
    }

    function basariliGiris(kullaniciAdi) {
        aktifKullanici = kullaniciAdi;
        let isMudur = (kullaniciAdi === 'MÃ¼dÃ¼r');
        const userStatusRef = database.ref('status/' + kullaniciAdi);
        userStatusRef.set({ state: 'online', last_changed: firebase.database.ServerValue.TIMESTAMP });
        userStatusRef.onDisconnect().remove();
        panelAc(isMudur);
    }

    function panelAc(isMudur) { 
        document.getElementById('loginScreen').style.display = 'none'; 
        document.getElementById('adminPanel').style.display = 'flex'; 
        if(isMudur) document.getElementById('webhookAyarKutusu').style.display = 'block';
        else document.getElementById('webhookAyarKutusu').style.display = 'none';
        verileriGetir(); 
        yoneticileriGetir(); 
        chatBaslat();
    }

    // --- YENÄ° TELSÄ°Z SÄ°STEMÄ° (JITSI) ---
    function telsizDurumDegistir() {
        const btn = document.getElementById('btnConnectRadio');
        const container = document.getElementById('jitsi-embed-container');

        if(jitsiApi) {
            // KAPAT
            jitsiApi.dispose();
            jitsiApi = null;
            btn.innerHTML = "ğŸ”´ TELSÄ°Z KAPALI";
            btn.classList.remove('connected');
            container.innerHTML = `<div class="jitsi-placeholder">Telsize baÄŸlanmak iÃ§in yukarÄ±daki butona basÄ±nÄ±z.<br><br>Mikrofon izni vermeyi unutmayÄ±n.</div>`;
        } else {
            // AÃ‡
            btn.innerHTML = "ğŸŸ¢ TELSÄ°Z AKTÄ°F";
            btn.classList.add('connected');
            container.innerHTML = ""; // Temizle

            const domain = "meet.jit.si";
            const options = {
                roomName: "EGM_Ozel_Telsiz_Kanali_2024_Kadir", // Sabit Oda AdÄ±
                width: "100%",
                height: "100%",
                parentNode: container,
                configOverwrite: {
                    startWithAudioMuted: false, // Mikrofon AÃ‡IK baÅŸla
                    startWithVideoMuted: true, // Kamera KAPALI baÅŸla
                    prejoinPageEnabled: false, // Bekleme odasÄ±nÄ± Ä°PTAL ET (Direkt gir)
                    disableDeepLinking: true // Uygulama indirmeyi Ã¶nle
                },
                interfaceConfigOverwrite: {
                    TOOLBAR_BUTTONS: ['microphone', 'tileview', 'settings'], // Sadece mikrofon butonu
                    SHOW_JITSI_WATERMARK: false,
                    SHOW_WATERMARK_FOR_GUESTS: false
                },
                userInfo: {
                    displayName: aktifKullanici
                }
            };
            jitsiApi = new JitsiMeetExternalAPI(domain, options);
            
            // Odaya girildiÄŸinde sesli uyarÄ± (Opsiyonel)
            // jitsiApi.executeCommand('playAudio', 'incomingMessage'); 
        }
    }

    // --- YAZILI SOHBET ---
    function chatBaslat() {
        database.ref('chat').limitToLast(50).on('child_added', snapshot => {
            const data = snapshot.val();
            const chatDiv = document.getElementById('chatMessages');
            let tip = (data.gonderen === aktifKullanici) ? 'msg-mine' : 'msg-other';
            let zaman = new Date(data.zaman).toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'});
            
            chatDiv.innerHTML += `
            <div class="message ${tip}">
                <span class="msg-info">${data.gonderen} â€¢ ${zaman}</span>
                ${data.mesaj}
            </div>`;
            chatDiv.scrollTop = chatDiv.scrollHeight;
        });
    }

    function mesajGonder() {
        const input = document.getElementById('chatInput');
        const msg = input.value.trim();
        if(msg) {
            database.ref('chat').push({
                gonderen: aktifKullanici,
                mesaj: msg,
                zaman: firebase.database.ServerValue.TIMESTAMP
            });
            input.value = "";
        }
    }
    function enterBas(e) { if(e.key === 'Enter') mesajGonder(); }

    // --- STANDART YÃ–NETÄ°M FONKSÄ°YONLARI ---
    function verileriGetir() {
        database.ref('basvurular').on('value', snapshot => {
            const liste = document.getElementById('basvuruListesi'); liste.innerHTML = ""; basvuruVerileri = {};
            if(!snapshot.exists()) { liste.innerHTML = "<tr><td colspan='4'>BaÅŸvuru yok.</td></tr>"; return; }
            snapshot.forEach(child => {
                const data = child.val(); const key = child.key; basvuruVerileri[key] = data;
                let renk = data.durum==='OnaylandÄ±'?'green':(data.durum==='Reddedildi'?'red':'orange');
                let durumYazi = data.durum==='Beklemede'?'DEÄERLENDÄ°RÄ°LÄ°YOR':data.durum;
                liste.innerHTML += `<tr><td><div onclick="discordIslem('${data.discord_id}')" class="discord-link" title="Kopyala & AÃ§"><span style="font-size:1.2rem;">ğŸ†”</span> ${data.discord_id} </div></td><td>${data.ic_isim}</td><td style="color:${renk}; font-weight:bold;">${durumYazi}</td><td><button onclick="detayAc('${key}')" class="btn btn-blue">Ä°ncele</button><button onclick="onayla('${key}')" class="btn btn-green">âœ“</button><button onclick="reddet('${key}')" class="btn btn-red">âœ—</button><button onclick="dbSil('basvurular/${key}')" class="btn btn-dark">ğŸ—‘ï¸</button></td></tr>`;
            });
        });
    }

    function discordIslem(id) { navigator.clipboard.writeText(id).then(() => { window.open(`https://discord.com/users/${id}`, '_blank'); }); }
    function onayla(key) { if(confirm("Onaylamak istiyor musun?")) { database.ref('basvurular/'+key).update({durum: 'OnaylandÄ±'}); discordLogGonder(key, "ONAYLANDI âœ…", 0x28a745); } }
    function reddet(key) { let s = prompt("Red sebebi:"); if(s) { database.ref('basvurular/'+key).update({ durum: 'Reddedildi', red_sebebi: s }); discordLogGonder(key, "REDDEDÄ°LDÄ° âŒ", 0xdc3545, s); } }
    function discordLogGonder(key, durumMetni, renk, sebep = "") {
        const url = localStorage.getItem('discordWebhook'); if(!url) return; 
        const data = basvuruVerileri[key];
        let fields = [{ name: "ğŸ‘¤ IC Ä°sim", value: data.ic_isim, inline: true }, { name: "ğŸ†” Discord ID", value: `<@${data.discord_id}> (${data.discord_id})`, inline: true }, { name: "ğŸ‚ OOC YaÅŸ", value: data.ooc_yas, inline: true }];
        if(sebep) fields.push({ name: "ğŸ“ Red Sebebi", value: sebep });
        const payload = { embeds: [{ title: `BaÅŸvuru Durumu: ${durumMetni}`, color: renk, fields: fields, footer: { text: "EGM YÃ¶netim Paneli" }, timestamp: new Date() }] };
        fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).catch(err => console.error(err));
    }

    function detayAc(key) {
        const data = basvuruVerileri[key]; document.getElementById('modalBaslik').innerText = `${data.ic_isim} - Detay`; let html = "";
        if(data.cevaplar) { for (const [id, val] of Object.entries(data.cevaplar)) { let txt = (data.soru_detaylari && data.soru_detaylari[id]) ? data.soru_detaylari[id] : (yedekSozluk[id] || id); html += `<div class="soru-item"><span class="soru-baslik">${txt}</span><div class="cevap-metni">${val}</div></div>`; } } else { html = "<p>Veri yok.</p>"; }
        if(data.red_sebebi) html += `<div style="margin-top:20px; border:2px solid red; padding:10px; border-radius:5px; color:red;"><strong>RED SEBEBÄ°:</strong> ${data.red_sebebi}</div>`;
        document.getElementById('modalIcerik').innerHTML = html; document.getElementById('detayModal').style.display = "block";
    }
    function modalKapat() { document.getElementById('detayModal').style.display = "none"; }

    function yoneticileriGetir() { 
        database.ref('yetkililer').on('value', s => { 
            const l = document.getElementById('yoneticiListesi'); l.innerHTML = ""; 
            s.forEach(c => { 
                let data = c.val();
                let isTargetMudur = (data.kadi === 'MÃ¼dÃ¼r');
                let isCurrentMudur = (aktifKullanici === 'MÃ¼dÃ¼r');
                let silBtn = "";
                if(isCurrentMudur && !isTargetMudur) { silBtn = `<button onclick="dbSil('yetkililer/${c.key}')" class="btn btn-red">Sil</button>`; } else { silBtn = `<span style="color:#aaa; font-size:0.8rem;">ğŸ”’</span>`; }
                let sifreBtn = "";
                if (isCurrentMudur) { sifreBtn = `<button onclick="sifreDegistir('${c.key}', '${data.kadi}')" class="btn btn-yellow">Åifre</button>`; } else { if (data.kadi === aktifKullanici) { sifreBtn = `<button onclick="sifreDegistir('${c.key}', '${data.kadi}')" class="btn btn-yellow">Åifre</button>`; } else { sifreBtn = `<span style="color:#aaa; font-size:0.8rem;">ğŸš«</span>`; } }
                l.innerHTML += `<tr><td>${data.kadi}</td><td>â€¢â€¢â€¢â€¢</td><td>${sifreBtn} ${silBtn}</td></tr>`; 
            }); 
        }); 
    }
    
    function sifreDegistir(key, kadi) {
        let yeniSifre = prompt(`"${kadi}" kullanÄ±cÄ±sÄ± iÃ§in yeni ÅŸifreyi girin:`);
        if(yeniSifre && yeniSifre.trim() !== "") {
            database.ref('yetkililer/'+key).update({sifre: yeniSifre.trim()});
            alert("Åifre gÃ¼ncellendi!");
        }
    }

    function yetkiliEkle() { const k=document.getElementById('yeniKadi').value.trim(), s=document.getElementById('yeniSifre').value.trim(); if(k&&s) { database.ref('yetkililer').push({kadi:k, sifre:s}); alert("Eklendi."); } }
    function dbSil(y) { if(confirm('Bu kaydÄ± silmek istediÄŸinize emin misiniz?')) database.ref(y).remove(); }
    function tabDegistir(id, el) { document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active')); document.getElementById(id).classList.add('active'); }
</script>
</body>
</html>
