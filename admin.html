<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>EGM Operasyon Merkezi</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://meet.jit.si/external_api.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg-color: #f0f2f5; --text-color: #333; --sidebar-bg: #162447; --sidebar-text: white; --card-bg: white; --table-header: #1f4068; }
        [data-theme="dark"] { --bg-color: #0f172a; --text-color: #e2e8f0; --sidebar-bg: #020617; --sidebar-text: #94a3b8; --card-bg: #1e293b; --table-header: #334155; }
        
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; transition: 0.3s; }
        .sidebar { width: 260px; background: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; padding: 20px; z-index: 2; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
        .content { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        
        .menu-item { padding: 12px 15px; cursor: pointer; color: inherit; border-radius: 8px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .menu-item:hover, .active-tab { background: rgba(255,255,255,0.1); color: #fff; transform: translateX(5px); }
        
        /* Dashboard */
        .stats-container { display: flex; gap: 20px; margin-bottom: 30px; }
        .stat-card { flex: 1; background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; border-left: 5px solid #007bff; }
        
        /* Tablolar */
        table { width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.1); }
        th { background: var(--table-header); color: white; }
        
        /* Butonlar & Inputlar */
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-green { background: #10b981; color: white; } .btn-red { background: #ef4444; color: white; } .btn-blue { background: #3b82f6; color: white; } .btn-dark { background: #374151; color: white; }
        .search-box { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 8px; background: var(--card-bg); color: var(--text-color); }

        /* Login & Modal */
        #loginScreen { position: fixed; top:0; left:0; width:100%; height:100%; background: #0f172a; z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 350px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); margin: 2% auto; padding: 0; width: 70%; border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; }
        
        /* Telsiz & Chat & Map */
        .radio-room-container { display: flex; height: 70vh; gap: 20px; }
        .radio-control { width: 300px; background: var(--sidebar-bg); border-radius: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .chat-area { flex: 1; background: var(--card-bg); border-radius: 10px; display: flex; flex-direction: column; border: 1px solid #ddd; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { padding: 10px; border-radius: 8px; max-width: 80%; font-size: 0.9rem; }
        .msg-mine { align-self: flex-end; background: #3b82f6; color: white; }
        .msg-other { align-self: flex-start; background: #f1f5f9; color: #333; }
        .map-frame { width: 100%; height: 75vh; border: none; border-radius: 10px; background: #000; }

        /* MÃ¼zik Ã‡alar */
        #musicPlayer { position: absolute; z-index: 9999; background: rgba(22, 36, 71, 0.95); backdrop-filter: blur(10px); border: 1px solid #00f7ff; width: 320px; border-radius: 10px; box-shadow: 0 0 20px rgba(0, 247, 255, 0.3); bottom: 20px; right: 20px; overflow: hidden; transition: height 0.3s; }
        #musicHeader { padding: 10px; cursor: move; background: linear-gradient(90deg, #1f4068, #162447); color: #00f7ff; display: flex; justify-content: space-between; align-items: center; font-weight: bold; border-bottom: 1px solid #00f7ff; }
        .music-body { padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .minimized { height: 40px !important; overflow: hidden; }
        .hidden { display: none; }
        
        .rutbe-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .rutbe-mudur { background: #ef4444; color: white; }
        .rutbe-komiser { background: #f59e0b; color: white; }
        .rutbe-memur { background: #3b82f6; color: white; }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <img src="egmm.png" style="width:80px; margin-bottom:10px;">
        <h2 style="color:#1e293b; margin:0;">GÃœVENLÄ°K GÄ°RÄ°ÅžÄ°</h2>
        <input type="text" id="kadi" class="login-input" style="width:100%; padding:10px; margin:5px 0;" placeholder="KullanÄ±cÄ± AdÄ±">
        <input type="password" id="sifre" class="login-input" style="width:100%; padding:10px; margin:5px 0;" placeholder="Åžifre">
        <button onclick="girisYap()" class="btn btn-blue" style="width:100%; margin-top:10px;">GiriÅŸ Yap</button>
        <p id="loginMsg" style="color:red; margin-top:10px;"></p>
    </div>
</div>

<div id="detayModal" class="modal">
    <div class="modal-content">
        <div style="padding:20px; background:var(--sidebar-bg); color:white; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0" id="modalBaslik">BaÅŸvuru DetayÄ±</h3>
            <div>
                <button onclick="pdfYazdir()" class="btn btn-green" style="font-size:0.8rem;"><i class="fas fa-print"></i> PDF Ä°NDÄ°R</button>
                <span onclick="modalKapat()" style="cursor:pointer; font-size:1.5rem; margin-left:15px;">&times;</span>
            </div>
        </div>
        <div style="padding:30px; overflow-y:auto; flex:1; display:flex; gap:20px;">
            <div style="flex:2;" id="modalIcerik"></div>
            <div style="flex:1; border-left:1px solid rgba(0,0,0,0.1); padding-left:20px;">
                <h4 style="margin-top:0; color:#1f4068;">ðŸ“‹ Tutanak / Notlar</h4>
                <div id="noteList" style="height:150px; overflow-y:auto; margin-bottom:10px; font-size:0.9rem;"></div>
                <textarea id="newNote" style="width:100%; height:60px;" placeholder="Gizli not ekle..."></textarea>
                <button onclick="notEkle()" class="btn btn-blue" style="width:100%; margin-top:5px;">Kaydet</button>
            </div>
        </div>
        <div style="padding:15px; background:rgba(0,0,0,0.05); text-align:right;"><button onclick="modalKapat()" class="btn btn-red">Kapat</button></div>
    </div>
</div>

<div id="musicPlayer">
    <div id="musicHeader"><span><i class="fas fa-broadcast-tower"></i> EGM MEDYA</span><div style="cursor:pointer;" onclick="toggleMusicPlayer()">_</div></div>
    <div class="music-body">
        <div style="display:flex; gap:5px;">
            <button class="btn btn-dark" style="flex:1; font-size:0.7rem;" onclick="radyoCal('https://dinle.trt.net.tr/mp3/radyohaber', 'TRT Haber')">ðŸ“¡ HABER</button>
            <button class="btn btn-dark" style="flex:1; font-size:0.7rem;" onclick="youtubeMod()">ðŸ“º YOUTUBE</button>
        </div>
        <div id="playerStatus" style="color:white; font-size:0.8rem; text-align:center;">HazÄ±r</div>
        <audio id="radioPlayer" controls class="hidden" style="width:100%;"></audio>
        <div id="ytContainer" class="hidden">
            <input type="text" id="musicUrl" style="width:100%;" placeholder="YouTube Link...">
            <button onclick="youtubeCal()" class="btn btn-blue" style="width:100%;">AÃ‡</button>
            <iframe id="ytPlayer" style="height:150px; margin-top:5px; width:100%;" src="" frameborder="0" allow="autoplay"></iframe>
        </div>
    </div>
</div>

<div id="adminPanel" style="display:none; width:100%;">
    <div class="sidebar">
        <div style="text-align:center; margin-bottom:20px;">
            <img src="egmm.png" style="width:50px;">
            <h3 style="margin:5px 0; font-size:1.1rem;">EGM PANEL</h3>
            <span id="aktifKullaniciAdi" style="font-size:0.9rem; font-weight:bold; color:#60a5fa;"></span><br>
            <span id="aktifRutbeGoster" class="rutbe-badge" style="font-size:0.7rem;"></span>
        </div>
        <div class="menu-item active-tab" onclick="tabDegistir('dashboardTab', this)"><i class="fas fa-home"></i> Ã–zet</div>
        <div class="menu-item" onclick="tabDegistir('basvurularTab', this)"><i class="fas fa-file-alt"></i> BaÅŸvurular</div>
        <div class="menu-item" onclick="tabDegistir('yoneticilerTab', this)"><i class="fas fa-users-cog"></i> Personel</div>
        <div class="menu-item" onclick="tabDegistir('mesaiTab', this)"><i class="fas fa-clock"></i> Mesai Takip</div>
        <div class="menu-item" onclick="tabDegistir('mapTab', this)"><i class="fas fa-map-marked-alt"></i> CanlÄ± Harita</div>
        <div class="menu-item" onclick="tabDegistir('sohbetTab', this)"><i class="fas fa-headset"></i> Komuta</div>
        <div class="menu-item" onclick="tabDegistir('logsTab', this)"><i class="fas fa-history"></i> Loglar</div>
        <div class="menu-item" onclick="tabDegistir('ayarlarTab', this)"><i class="fas fa-cog"></i> Ayarlar</div>
        
        <div style="margin-top:auto;">
            <button onclick="mesaiBitirVeCikis()" class="btn btn-red" style="width:100%; justify-content:center;"><i class="fas fa-sign-out-alt"></i> MESAÄ°YÄ° BÄ°TÄ°R</button>
        </div>
    </div>

    <div class="content">
        <div id="dashboardTab" class="tab-content active">
            <h2 style="margin-bottom:20px;">Genel Durum</h2>
            <div class="stats-container">
                <div class="stat-card" style="border-color:#3b82f6;"><div class="stat-info"><h3 id="statToplam">0</h3><p>Toplam</p></div><i class="fas fa-folder fa-2x"></i></div>
                <div class="stat-card" style="border-color:#f59e0b;"><div class="stat-info"><h3 id="statBekleyen">0</h3><p>Bekleyen</p></div><i class="fas fa-clock fa-2x"></i></div>
                <div class="stat-card" style="border-color:#10b981;"><div class="stat-info"><h3 id="statOnay">0</h3><p>Onay</p></div><i class="fas fa-check fa-2x"></i></div>
            </div>
        </div>

        <div id="basvurularTab" class="tab-content">
            <div style="display:flex; justify-content:space-between;"><h2>BaÅŸvurular</h2><button onclick="excelIndir()" class="btn btn-green">Excel Ä°ndir</button></div>
            <input type="text" id="basvuruAra" class="search-box" placeholder="ðŸ” Ara..." onkeyup="tabloAra('basvuruAra', 'basvuruListesi')">
            <table><thead><tr><th>ID</th><th>Ä°sim</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead><tbody id="basvuruListesi"></tbody></table>
        </div>

        <div id="yoneticilerTab" class="tab-content">
            <h2>Personel Listesi</h2>
            <div style="background:var(--card-bg); padding:15px; margin-bottom:20px; border-radius:8px;">
                <h4 style="margin-top:0;">Yeni Personel Ekle</h4>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="yeniKadi" placeholder="KullanÄ±cÄ± AdÄ±" style="flex:1; padding:8px; border:1px solid #ccc;">
                    <input type="password" id="yeniSifre" placeholder="Åžifre" style="flex:1; padding:8px; border:1px solid #ccc;">
                    <select id="yeniRutbe" style="padding:8px; border:1px solid #ccc;">
                        <option value="Memur">Memur</option>
                        <option value="Komiser">Komiser</option>
                        <option value="MÃ¼dÃ¼r">MÃ¼dÃ¼r</option>
                    </select>
                    <button onclick="yetkiliEkle()" class="btn btn-green">Ekle</button>
                </div>
            </div>
            <table><thead><tr><th>KullanÄ±cÄ±</th><th>RÃ¼tbe</th><th>Ä°ÅŸlem</th></tr></thead><tbody id="yoneticiListesi"></tbody></table>
        </div>

        <div id="mesaiTab" class="tab-content">
            <h2>Mesai KayÄ±tlarÄ±</h2>
            <p>Personelin giriÅŸ ve Ã§Ä±kÄ±ÅŸ saatleri otomatik kaydedilir.</p>
            <table><thead><tr><th>Personel</th><th>GiriÅŸ</th><th>Ã‡Ä±kÄ±ÅŸ</th><th>SÃ¼re (Dk)</th></tr></thead><tbody id="mesaiListesi"></tbody></table>
        </div>

        <div id="mapTab" class="tab-content">
            <h2>CanlÄ± Sunucu HaritasÄ±</h2>
            <iframe id="liveMapFrame" class="map-frame" src=""></iframe>
            <div style="text-align:center; padding:20px; color:#aaa;" id="noMapMsg">
                Harita URL'si ayarlanmamÄ±ÅŸ. <br>Ayarlar sekmesinden sunucu harita linkini giriniz.
            </div>
        </div>

        <div id="ayarlarTab" class="tab-content">
            <h2>Sistem AyarlarÄ±</h2>
            <div style="background:var(--card-bg); padding:20px; margin-bottom:20px; border-radius:8px;">
                <label>Discord Webhook URL:</label>
                <input type="password" id="webhookUrl" class="search-box" onchange="webhookKaydet()">
                
                <label>CanlÄ± Harita URL (Varsa):</label>
                <input type="text" id="mapUrlInput" class="search-box" placeholder="http://sunucuip:port/livemap" onchange="mapUrlKaydet()">
                
                <button onclick="temaDegistir()" class="btn btn-dark">Tema DeÄŸiÅŸtir</button>
            </div>

            <h3 style="color:#ef4444;">Kara Liste (Ban)</h3>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input type="text" id="yasakliID" placeholder="Discord ID" class="search-box" style="margin:0;">
                <button onclick="yasakla()" class="btn btn-red">YASAKLA</button>
            </div>
            <table><thead><tr><th>ID</th><th>Sebep</th><th>Ä°ÅŸlem</th></tr></thead><tbody id="blacklistListesi"></tbody></table>
        </div>

        <div id="sohbetTab" class="tab-content">
            <h2>Komuta Kontrol</h2>
            <div class="radio-room-container">
                <div class="radio-control">
                    <div style="padding:15px; text-align:center; color:#94a3b8; font-weight:bold; background:rgba(0,0,0,0.2);">TELSÄ°Z</div>
                    <div style="padding:20px; text-align:center;"><button id="btnConnectRadio" onclick="telsizDurumDegistir()" class="btn btn-red" style="width:100%; border-radius:20px;">BAÄžLAN</button></div>
                    <div id="jitsi-embed-container" style="flex:1; background:black;"></div>
                </div>
                <div class="chat-area">
                    <div style="padding:15px; border-bottom:1px solid #ddd;">YazÄ±lÄ± Kanal</div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div style="padding:15px; display:flex; gap:10px;">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Mesaj..." style="flex:1;" onkeydown="enterBas(event)">
                        <button onclick="mesajGonder()" class="btn btn-blue">GÃ–NDER</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="logsTab" class="tab-content">
            <h2>Log KayÄ±tlarÄ±</h2>
            <table><thead><tr><th>Zaman</th><th>YÃ¶netici</th><th>Ä°ÅŸlem</th><th>Detay</th></tr></thead><tbody id="logListesi"></tbody></table>
        </div>
    </div>
</div>

<script src="config.js"></script>
<script>
    const SFX = { success: new Audio("https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg"), error: new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"), alert: new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg"), click: new Audio("https://actions.google.com/sounds/v1/ui/click_on.ogg") };
    SFX.success.volume = 0.5; SFX.error.volume = 0.5; SFX.alert.volume = 0.4; SFX.click.volume = 0.2;

    let basvuruVerileri = {};
    let aktifKullanici = "";
    let aktifRutbe = ""; // Memur, Komiser, MÃ¼dÃ¼r
    let jitsiApi = null;
    let aktifBasvuruKey = null;
    let mesaiBaslangic = null;

    // --- BAÅžLANGIÃ‡ ---
    window.onload = function() {
        const wh = localStorage.getItem('discordWebhook'); if(wh) document.getElementById('webhookUrl').value = wh;
        const mp = localStorage.getItem('mapUrl'); if(mp) { document.getElementById('mapUrlInput').value = mp; document.getElementById('liveMapFrame').src = mp; document.getElementById('liveMapFrame').style.display='block'; document.getElementById('noMapMsg').style.display='none'; } else { document.getElementById('liveMapFrame').style.display='none'; }
        if(localStorage.getItem('tema') === 'dark') document.body.setAttribute('data-theme', 'dark');
        youtubeMod();
    }

    // --- GÄ°RÄ°Åž VE RÃœTBE KONTROLÃœ ---
    function girisYap() {
        SFX.click.play();
        const k = document.getElementById('kadi').value.trim();
        const s = document.getElementById('sifre').value.trim();
        
        if (k === "MÃ¼dÃ¼r" && s === "GÃ¶kSancak1881") { 
            // Master Hesap Yoksa OluÅŸtur
            database.ref('yetkililer').orderByChild('kadi').equalTo('MÃ¼dÃ¼r').once('value', x => { if(!x.exists()) database.ref('yetkililer').push({kadi: 'MÃ¼dÃ¼r', sifre: 'GÃ¶kSancak1881', rutbe:'MÃ¼dÃ¼r'}); }); 
            basariliGiris(k, 'MÃ¼dÃ¼r'); 
            return; 
        }
        
        database.ref('yetkililer').orderByChild('kadi').equalTo(k).once('value', sn => { 
            let found = false; let rutbe = 'Memur';
            sn.forEach(c => { 
                if(c.val().sifre === s) { found = true; rutbe = c.val().rutbe || 'Memur'; } 
            }); 
            if(found) basariliGiris(k, rutbe); 
            else { SFX.error.play(); document.getElementById('loginMsg').innerText = "HatalÄ± GiriÅŸ!"; } 
        });
    }

    function basariliGiris(isim, rutbe) {
        SFX.success.play();
        aktifKullanici = isim; 
        aktifRutbe = rutbe;
        mesaiBaslangic = Date.now(); // Mesai BaÅŸladÄ±

        document.getElementById('aktifKullaniciAdi').innerText = isim;
        document.getElementById('aktifRutbeGoster').innerText = rutbe;
        document.getElementById('aktifRutbeGoster').className = `rutbe-badge rutbe-${rutbe.toLowerCase().replace('Ã¼','u').replace('Ã¶','o')}`;
        
        document.getElementById('loginScreen').style.display = 'none'; 
        document.getElementById('adminPanel').style.display = 'flex';
        
        // MÃ¼dÃ¼r deÄŸilse ayarlarÄ±n bazÄ±larÄ±nÄ± gizle
        if(rutbe !== 'MÃ¼dÃ¼r') {
            document.getElementById('webhookAyarKutusu').style.display = 'none';
        }

        logKaydet("GiriÅŸ", `${isim} (${rutbe}) mesaiye baÅŸladÄ±.`);
        verileriGetir(); yoneticileriGetir(); blacklistGetir(); loglariGetir(); mesaileriGetir(); chatBaslat();
    }

    function mesaiBitirVeCikis() {
        if(confirm("Mesaiyi bitirip Ã§Ä±kÄ±ÅŸ yapmak istiyor musun?")) {
            const bitis = Date.now();
            const sureDk = Math.floor((bitis - mesaiBaslangic) / 60000);
            
            database.ref('mesai').push({
                personel: aktifKullanici,
                giris: mesaiBaslangic,
                cikis: bitis,
                sure: sureDk
            });
            
            logKaydet("Ã‡Ä±kÄ±ÅŸ", `Mesai bitti. SÃ¼re: ${sureDk} dk.`);
            location.reload();
        }
    }

    // --- YETKÄ° KONTROLLÃœ Ä°ÅžLEMLER ---
    function yetkiKontrol(izinVerilenler) {
        if (!izinVerilenler.includes(aktifRutbe)) {
            SFX.error.play();
            alert("â›” Yetkiniz Yetersiz! (Gereken: " + izinVerilenler.join(' veya ') + ")");
            return false;
        }
        return true;
    }

    function onayla(k) { 
        if(!yetkiKontrol(['MÃ¼dÃ¼r', 'Komiser'])) return;
        if(confirm("Onay?")) { database.ref('basvurular/'+k).update({durum:'OnaylandÄ±'}); logKaydet("Onay", basvuruVerileri[k].discord_id); dcLog(k, "ONAYLANDI âœ…", 0x10b981); SFX.success.play(); } 
    }
    
    function reddet(k) { 
        if(!yetkiKontrol(['MÃ¼dÃ¼r', 'Komiser'])) return;
        let s = prompt("Sebep?"); 
        if(s) { database.ref('basvurular/'+k).update({durum:'Reddedildi', red_sebebi:s}); logKaydet("Red", s); dcLog(k, "REDDEDÄ°LDÄ° âŒ", 0xef4444, s); SFX.error.play(); } 
    }
    
    function dbSil(yol) { 
        if(!yetkiKontrol(['MÃ¼dÃ¼r'])) return; // Sadece MÃ¼dÃ¼r silebilir
        if(confirm("Sil?")) { database.ref(yol).remove(); logKaydet("Silme", yol); SFX.error.play(); } 
    }

    function yetkiliEkle() {
        if(!yetkiKontrol(['MÃ¼dÃ¼r'])) return;
        let k = document.getElementById('yeniKadi').value;
        let s = document.getElementById('yeniSifre').value;
        let r = document.getElementById('yeniRutbe').value;
        if(k&&s) { database.ref('yetkililer').push({kadi:k, sifre:s, rutbe:r}); logKaydet("Personel Ekleme", `${k} (${r}) eklendi.`); SFX.success.play(); alert("Eklendi."); }
    }

    // --- DÄ°ÄžER FONKSÄ°YONLAR ---
    function logKaydet(i, d) { database.ref('logs').push({ zaman: firebase.database.ServerValue.TIMESTAMP, yonetici: aktifKullanici, islem: i, detay: d }); }
    function loglariGetir() { database.ref('logs').limitToLast(50).on('value', s => { const l = document.getElementById('logListesi'); l.innerHTML = ""; let a = []; s.forEach(c => a.push(c.val())); a.reverse().forEach(log => { let t = new Date(log.zaman).toLocaleString('tr-TR'); l.innerHTML += `<tr><td><small>${t}</small></td><td><b>${log.yonetici}</b></td><td>${log.islem}</td><td>${log.detay}</td></tr>`; }); }); }
    function mesaileriGetir() { database.ref('mesai').limitToLast(50).on('value', s => { const l = document.getElementById('mesaiListesi'); l.innerHTML = ""; let a = []; s.forEach(c => a.push(c.val())); a.reverse().forEach(m => { l.innerHTML += `<tr><td>${m.personel}</td><td>${new Date(m.giris).toLocaleTimeString()}</td><td>${new Date(m.cikis).toLocaleTimeString()}</td><td>${m.sure} Dk</td></tr>`; }); }); }

    function verileriGetir() {
        database.ref('basvurular').on('value', s => {
            const l = document.getElementById('basvuruListesi'); l.innerHTML = ""; basvuruVerileri = {};
            let [t, b, o, r] = [0, 0, 0, 0];
            s.forEach(c => {
                const d = c.val(); const k = c.key; basvuruVerileri[k] = d;
                t++; if(d.durum === 'Beklemede') b++; else if(d.durum === 'OnaylandÄ±') o++; else r++;
                let renk = d.durum==='OnaylandÄ±'?'#10b981':(d.durum==='Reddedildi'?'#ef4444':'#f59e0b');
                l.innerHTML += `<tr><td>${d.discord_id}</td><td>${d.ic_isim}</td><td style="color:${renk}; font-weight:bold;">${d.durum}</td><td>
                    <button onclick="detayAc('${k}')" class="btn btn-blue"><i class="fas fa-eye"></i></button>
                    <button onclick="onayla('${k}')" class="btn btn-green"><i class="fas fa-check"></i></button>
                    <button onclick="reddet('${k}')" class="btn btn-red"><i class="fas fa-times"></i></button>
                    <button onclick="dbSil('basvurular/${k}')" class="btn btn-dark"><i class="fas fa-trash"></i></button>
                </td></tr>`;
            });
            document.getElementById('statToplam').innerText = t; document.getElementById('statBekleyen').innerText = b; document.getElementById('statOnay').innerText = o; document.getElementById('statRed').innerText = r;
        });
    }

    function yoneticileriGetir() { database.ref('yetkililer').on('value', s => { const l = document.getElementById('yoneticiListesi'); l.innerHTML=""; s.forEach(c => { let d = c.val(); let del = (aktifKullanici==='MÃ¼dÃ¼r' && d.kadi!=='MÃ¼dÃ¼r') ? `<button onclick="dbSil('yetkililer/${c.key}')" class="btn btn-red">Sil</button>` : 'ðŸ”’'; l.innerHTML += `<tr><td>${d.kadi}</td><td><span class="rutbe-badge rutbe-${(d.rutbe||'Memur').toLowerCase()}">${d.rutbe||'Memur'}</span></td><td>${del}</td></tr>`; }); }); }

    // --- DETAY, PDF, NOT ---
    function detayAc(k) {
        SFX.click.play(); aktifBasvuruKey = k; const d = basvuruVerileri[k];
        let h = ""; if(d.cevaplar) { for(let [x,y] of Object.entries(d.cevaplar)) h+=`<div><b style="color:#3b82f6;">${x}:</b><br>${y}</div><hr style="margin:5px 0; border-color:#eee;">`; } 
        document.getElementById('modalIcerik').innerHTML = h;
        
        const nl = document.getElementById('noteList'); nl.innerHTML = "YÃ¼kleniyor...";
        database.ref('basvurular/' + k + '/yonetici_notlari').on('value', snap => {
            nl.innerHTML = ""; if(!snap.exists()) { nl.innerHTML = "Not yok."; return; }
            snap.forEach(c => { let n = c.val(); nl.innerHTML += `<div style="border-bottom:1px solid #eee; padding:5px;"><b style="color:#3b82f6;">${n.yazan}:</b> ${n.mesaj}</div>`; });
        });
        document.getElementById('detayModal').style.display='block';
    }
    function notEkle() { const t = document.getElementById('newNote').value.trim(); if(t && aktifBasvuruKey) { database.ref('basvurular/'+aktifBasvuruKey+'/yonetici_notlari').push({yazan:aktifKullanici, mesaj:t}); document.getElementById('newNote').value=""; } }
    
    function pdfYazdir() {
        const d = basvuruVerileri[aktifBasvuruKey]; if(!d) return;
        let w = window.open('','','width=800,height=900');
        w.document.write(`<html><head><title>${d.ic_isim}</title><style>body{font-family:monospace;padding:40px;}h1{text-align:center;border-bottom:2px solid black;}</style></head><body><h1>EGM PERSONEL DOSYASI</h1><p><b>ID:</b> ${d.discord_id}</p><p><b>Ä°SÄ°M:</b> ${d.ic_isim}</p><p><b>DURUM:</b> ${d.durum}</p><hr><h3>MÃœLAKAT</h3>${document.getElementById('modalIcerik').innerHTML}<script>window.print()<\/script></body></html>`);
        w.document.close();
    }

    // --- YARDIMCILAR ---
    function modalKapat() { document.getElementById('detayModal').style.display='none'; }
    function webhookKaydet() { localStorage.setItem('discordWebhook', document.getElementById('webhookUrl').value); }
    function mapUrlKaydet() { const u = document.getElementById('mapUrlInput').value; localStorage.setItem('mapUrl', u); document.getElementById('liveMapFrame').src = u; location.reload(); }
    function temaDegistir() { if(document.body.getAttribute('data-theme')==='dark') { document.body.removeAttribute('data-theme'); localStorage.setItem('tema','light'); } else { document.body.setAttribute('data-theme','dark'); localStorage.setItem('tema','dark'); } }
    function tabDegistir(i, e) { SFX.click.play(); document.querySelectorAll('.tab-content').forEach(d=>d.classList.remove('active')); document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active-tab')); document.getElementById(i).classList.add('active'); e.classList.add('active-tab'); }
    function tabloAra(i, t) { let v = document.getElementById(i).value.toLowerCase(); document.querySelectorAll('#'+t+' tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(v) ? '' : 'none'); }
    function excelIndir() { let h = document.getElementById("basvuruListesi").outerHTML; let b = new Blob(["\ufeff", "<table>"+h+"</table>"], {type:"application/vnd.ms-excel"}); let a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download="liste.xls"; a.click(); }
    
    // MÃ¼zik & Radyo & Chat
    dragElement(document.getElementById("musicPlayer")); function toggleMusicPlayer() { document.getElementById("musicPlayer").classList.toggle("minimized"); SFX.click.play(); }
    function radyoCal(u, n) { document.getElementById("playerStatus").innerText="Ã‡alÄ±yor: "+n; document.getElementById("ytContainer").classList.add("hidden"); const a=document.getElementById("radioPlayer"); a.src=u; a.classList.remove("hidden"); a.play().catch(e=>alert("Hata")); }
    function youtubeMod() { document.getElementById("playerStatus").innerText="Mod: YouTube"; document.getElementById("radioPlayer").pause(); document.getElementById("radioPlayer").classList.add("hidden"); document.getElementById("ytContainer").classList.remove("hidden"); }
    function youtubeCal() { const u=document.getElementById('musicUrl').value; const m=u.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/); if(m&&m[2].length===11) document.getElementById('ytPlayer').src=`https://www.youtube.com/embed/${m[2]}?autoplay=1`; else alert("Link HatalÄ±"); }
    function dragElement(e){var n=0,t=0,o=0,l=0;function u(e){(e=e||window.event).preventDefault(),o=e.clientX,l=e.clientY,document.onmouseup=d,document.onmousemove=m}function m(u){(u=u||window.event).preventDefault(),n=o-u.clientX,t=l-u.clientY,o=u.clientX,l=u.clientY,e.style.top=e.offsetTop-t+"px",e.style.left=e.offsetLeft-n+"px"}function d(){document.onmouseup=null,document.onmousemove=null}document.getElementById("musicHeader").onmousedown=u}
    
    function telsizDurumDegistir() { const b = document.getElementById('btnConnectRadio'); const c = document.getElementById('jitsi-embed-container'); if(jitsiApi) { jitsiApi.dispose(); jitsiApi=null; b.innerText="BAÄžLAN"; b.classList.remove('btn-green'); b.classList.add('btn-red'); c.innerHTML=""; } else { b.innerText="AYRIL"; b.classList.remove('btn-red'); b.classList.add('btn-green'); jitsiApi = new JitsiMeetExternalAPI("meet.jit.si", { roomName: "EGM_Ozel_Kanal_2024", width: "100%", height: "100%", parentNode: c, configOverwrite: { startWithAudioMuted: false, startWithVideoMuted: true, prejoinPageEnabled: false }, userInfo: { displayName: aktifKullanici } }); } }
    function chatBaslat() { database.ref('chat').limitToLast(50).on('child_added', s => { const d = s.val(); let div = document.getElementById('chatMessages'); let cls = d.gonderen===aktifKullanici ? 'msg-mine' : 'msg-other'; div.innerHTML += `<div class="message ${cls}"><b>${d.gonderen}:</b> ${d.mesaj}</div>`; div.scrollTop = div.scrollHeight; if(d.gonderen!==aktifKullanici) SFX.alert.play().catch(e=>{}); }); }
    function mesajGonder() { let i = document.getElementById('chatInput'); if(i.value.trim()) { database.ref('chat').push({gonderen:aktifKullanici, mesaj:i.value.trim(), zaman:firebase.database.ServerValue.TIMESTAMP}); i.value=""; } }
    function enterBas(e) { if(e.key==='Enter') mesajGonder(); }
    function dcLog(k, t, c, s="") { const u = localStorage.getItem('discordWebhook'); if(!u) return; const d = basvuruVerileri[k]; fetch(u, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({embeds:[{title:t, color:c, fields:[{name:"Ä°sim", value:d.ic_isim},{name:"ID", value:d.discord_id},{name:"Not", value:s||"-"}]}]})}); }
    function blacklistGetir() { database.ref('blacklist').on('value', s => { const l = document.getElementById('blacklistListesi'); l.innerHTML=""; s.forEach(c => l.innerHTML += `<tr><td>${c.val().discord_id}</td><td>${c.val().sebep}</td><td><button onclick="dbSil('blacklist/${c.key}')" class="btn btn-red">Sil</button></td></tr>`); }); }
    function yasakla() { const i = document.getElementById('yasakliID').value.trim(); const s = document.getElementById('yasakSebep').value.trim(); if(i) { database.ref('blacklist').push({ discord_id: i, sebep: s }); logKaydet("Yasak", i+" yasaklandÄ±."); alert("YasaklandÄ±"); } }
</script>
</body>
</html>
