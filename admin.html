<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>EGM Personel YÃ¶netim</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://meet.jit.si/external_api.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg-color: #f0f2f5; --text-color: #333; --sidebar-bg: #162447; --sidebar-text: white; --card-bg: white; --table-header: #1f4068; }
        [data-theme="dark"] { --bg-color: #0f172a; --text-color: #e2e8f0; --sidebar-bg: #020617; --sidebar-text: #94a3b8; --card-bg: #1e293b; --table-header: #334155; }
        
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; transition: 0.3s; }
        .sidebar { width: 260px; background: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; padding: 20px; z-index: 2; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
        .content { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        
        .menu-item { padding: 12px 15px; cursor: pointer; color: inherit; border-radius: 8px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .menu-item:hover, .active-tab { background: rgba(255,255,255,0.1); color: #fff; transform: translateX(5px); }
        .menu-icon { width: 20px; text-align: center; }

        .stats-container { display: flex; gap: 20px; margin-bottom: 30px; }
        .stat-card { flex: 1; background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; border-left: 5px solid #007bff; }
        .stat-info h3 { margin: 0; font-size: 2rem; color: var(--text-color); }
        .stat-icon { font-size: 2.5rem; opacity: 0.2; }

        table { width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.1); }
        th { background: var(--table-header); color: white; }
        
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-green { background: #10b981; color: white; } .btn-red { background: #ef4444; color: white; } .btn-blue { background: #3b82f6; color: white; } .btn-dark { background: #374151; color: white; }
        .search-box { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 8px; background: var(--card-bg); color: var(--text-color); }

        #loginScreen { position: fixed; top:0; left:0; width:100%; height:100%; background: #0f172a; z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 350px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; }
        
        /* Modal & Notlar */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); margin: 2% auto; padding: 0; width: 70%; border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; }
        
        .note-area { background: rgba(0,0,0,0.03); padding: 15px; border-radius: 5px; margin-top: 15px; border: 1px solid rgba(0,0,0,0.1); }
        .note-list { max-height: 150px; overflow-y: auto; margin-bottom: 10px; font-size: 0.9rem; }
        .note-item { padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; justify-content: space-between; }
        .note-author { font-weight: bold; color: #3b82f6; }
        
        .tab-content { display: none; animation: fadeIn 0.3s; } .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .webhook-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; margin-top: auto; font-size: 0.8rem; display: none; }

        /* Telsiz & Chat */
        .radio-room-container { display: flex; height: 70vh; gap: 20px; }
        .radio-control { width: 300px; background: var(--sidebar-bg); border-radius: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .chat-area { flex: 1; background: var(--card-bg); border-radius: 10px; display: flex; flex-direction: column; border: 1px solid #ddd; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { padding: 10px; border-radius: 8px; max-width: 80%; font-size: 0.9rem; }
        .msg-mine { align-self: flex-end; background: #3b82f6; color: white; }
        .msg-other { align-self: flex-start; background: #f1f5f9; color: #333; }

        /* MÃ¼zik Ã‡alar */
        #musicPlayer { position: absolute; z-index: 9999; background: rgba(22, 36, 71, 0.95); backdrop-filter: blur(10px); border: 1px solid #00f7ff; width: 320px; border-radius: 10px; box-shadow: 0 0 20px rgba(0, 247, 255, 0.3); bottom: 20px; right: 20px; overflow: hidden; transition: height 0.3s; }
        #musicHeader { padding: 10px; cursor: move; background: linear-gradient(90deg, #1f4068, #162447); color: #00f7ff; display: flex; justify-content: space-between; align-items: center; font-weight: bold; border-bottom: 1px solid #00f7ff; }
        .music-body { padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .minimized { height: 40px !important; overflow: hidden; }
        .radio-btn-group { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 5px; }
        .btn-radio { flex: 1; padding: 5px; font-size: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid #00f7ff; color: #00f7ff; cursor: pointer; border-radius: 3px; }
        .btn-radio:hover { background: #00f7ff; color: #000; }
        #ytPlayer, #radioPlayer { width: 100%; border-radius: 5px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <img src="egmm.png" style="width:80px; margin-bottom:10px;">
        <h2 style="color:#1e293b; margin:0;">YÃ–NETÄ°M PANELÄ°</h2>
        <input type="text" id="kadi" class="login-input" placeholder="KullanÄ±cÄ± AdÄ±">
        <input type="password" id="sifre" class="login-input" placeholder="Åžifre">
        <button onclick="girisYap()" class="btn btn-blue" style="width:100%; padding:12px; margin-top:10px;">GiriÅŸ Yap</button>
        <p id="loginMsg" style="color:red; margin-top:10px;"></p>
    </div>
</div>

<div id="detayModal" class="modal">
    <div class="modal-content">
        <div style="padding:20px; background:var(--sidebar-bg); color:white; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0" id="modalBaslik">BaÅŸvuru DetayÄ±</h3>
            <div>
                <button onclick="pdfYazdir()" class="btn btn-green" style="font-size:0.8rem;"><i class="fas fa-print"></i> DOSYAYI YAZDIR</button>
                <span onclick="modalKapat()" style="cursor:pointer; font-size:1.5rem; margin-left:15px;">&times;</span>
            </div>
        </div>
        
        <div style="padding:30px; overflow-y:auto; flex:1; display:flex; gap:20px;">
            <div style="flex:2;" id="modalIcerik"></div>
            
            <div style="flex:1; border-left:1px solid rgba(0,0,0,0.1); padding-left:20px;">
                <h4 style="margin-top:0; color:#1f4068;">ðŸ“‹ YÃ¶netici NotlarÄ±</h4>
                <div class="note-list" id="noteList">YÃ¼kleniyor...</div>
                <textarea id="newNote" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:5px; height:60px;" placeholder="Not ekle..."></textarea>
                <button onclick="notEkle()" class="btn btn-blue" style="width:100%; margin-top:5px;">Notu Kaydet</button>
            </div>
        </div>

        <div style="padding:15px; background:rgba(0,0,0,0.05); text-align:right;"><button onclick="modalKapat()" class="btn btn-red">Kapat</button></div>
    </div>
</div>

<div id="musicPlayer">
    <div id="musicHeader"><span><i class="fas fa-broadcast-tower"></i> EGM MEDYA</span><div style="cursor:pointer;" onclick="toggleMusicPlayer()">_</div></div>
    <div class="music-body">
        <div class="radio-btn-group">
            <button class="btn-radio" onclick="radyoCal('https://dinle.trt.net.tr/mp3/radyohaber', 'TRT Haber')">ðŸ“¡ HABER</button>
            <button class="btn-radio" onclick="radyoCal('https://listen.powerapp.com.tr/powerturk/icecast.audio', 'Power TÃ¼rk')">ðŸŽ¸ POWER</button>
            <button class="btn-radio" onclick="radyoCal('https://fenomen.listenfenomen.com/fenomen/128/icecast.audio', 'Fenomen')">ðŸ”¥ FENOMEN</button>
            <button class="btn-radio" onclick="youtubeMod()">ðŸ“º YOUTUBE</button>
        </div>
        <div id="playerStatus" style="color:white; font-size:0.8rem; text-align:center;">MÃ¼zik SeÃ§ilmedi</div>
        <audio id="radioPlayer" controls class="hidden" style="width:100%; margin-top:5px;"></audio>
        <div id="ytContainer" class="hidden">
            <input type="text" id="musicUrl" style="width:100%; box-sizing:border-box; margin-bottom:5px; padding:5px; background:rgba(0,0,0,0.5); color:white; border:1px solid #00f7ff;" placeholder="YouTube Linki...">
            <button onclick="youtubeCal()" class="btn btn-blue" style="width:100%; padding:5px;">VÄ°DEOYU AÃ‡</button>
            <iframe id="ytPlayer" style="height:150px; margin-top:5px;" src="" frameborder="0" allow="autoplay; encrypted-media"></iframe>
        </div>
    </div>
</div>

<div id="adminPanel" style="display:none; width:100%;">
    <div class="sidebar">
        <div style="text-align:center; margin-bottom:30px;">
            <img src="egmm.png" style="width:60px;">
            <h3 style="margin:10px 0 0 0; font-size:1.2rem;">EGM PANEL</h3>
            <span id="aktifKullaniciAdi" style="font-size:0.8rem; color:#94a3b8;">YÃ¶netici</span>
        </div>
        <div class="menu-item active-tab" onclick="tabDegistir('dashboardTab', this)"><div class="menu-icon"><i class="fas fa-home"></i></div> Ã–zet</div>
        <div class="menu-item" onclick="tabDegistir('basvurularTab', this)"><div class="menu-icon"><i class="fas fa-file-alt"></i></div> BaÅŸvurular</div>
        <div class="menu-item" onclick="tabDegistir('yoneticilerTab', this)"><div class="menu-icon"><i class="fas fa-users-cog"></i></div> Personel</div>
        <div class="menu-item" onclick="tabDegistir('blacklistTab', this)"><div class="menu-icon"><i class="fas fa-ban"></i></div> Kara Liste</div>
        <div class="menu-item" onclick="tabDegistir('logsTab', this)"><div class="menu-icon"><i class="fas fa-history"></i></div> Loglar</div>
        <div class="menu-item" onclick="tabDegistir('sohbetTab', this)"><div class="menu-icon"><i class="fas fa-headset"></i></div> Komuta</div>
        <div style="margin-top:auto;">
            <div id="webhookAyarKutusu" class="webhook-box">
                <label>Webhook URL:</label>
                <input type="password" id="webhookUrl" style="width:100%; border:none; border-radius:3px; padding:3px;" onchange="webhookKaydet()">
            </div>
            <div class="menu-item" onclick="temaDegistir()"><div class="menu-icon"><i class="fas fa-adjust"></i></div> Tema</div>
            <div class="menu-item" onclick="location.reload()" style="color:#ef4444;"><div class="menu-icon"><i class="fas fa-sign-out-alt"></i></div> Ã‡Ä±kÄ±ÅŸ</div>
        </div>
    </div>

    <div class="content">
        <div id="dashboardTab" class="tab-content active">
            <h2 style="margin-bottom:20px;">Genel Durum</h2>
            <div class="stats-container">
                <div class="stat-card" style="border-color:#3b82f6;"><div class="stat-info"><h3 id="statToplam">0</h3><p>Toplam</p></div><div class="stat-icon"><i class="fas fa-folder"></i></div></div>
                <div class="stat-card" style="border-color:#f59e0b;"><div class="stat-info"><h3 id="statBekleyen">0</h3><p>Bekleyen</p></div><div class="stat-icon"><i class="fas fa-clock"></i></div></div>
                <div class="stat-card" style="border-color:#10b981;"><div class="stat-info"><h3 id="statOnay">0</h3><p>Onay</p></div><div class="stat-icon"><i class="fas fa-check"></i></div></div>
                <div class="stat-card" style="border-color:#ef4444;"><div class="stat-info"><h3 id="statRed">0</h3><p>Red</p></div><div class="stat-icon"><i class="fas fa-times"></i></div></div>
            </div>
        </div>

        <div id="basvurularTab" class="tab-content">
            <div style="display:flex; justify-content:space-between; align-items:center;"><h2>Gelen BaÅŸvurular</h2><button onclick="excelIndir()" class="btn btn-green"><i class="fas fa-file-excel"></i> Excel</button></div>
            <input type="text" id="basvuruAra" class="search-box" placeholder="ðŸ” Ara..." onkeyup="tabloAra('basvuruAra', 'basvuruListesi')">
            <table><thead><tr><th>ID</th><th>Ä°sim</th><th>Durum</th><th>Tarih</th><th>Ä°ÅŸlem</th></tr></thead><tbody id="basvuruListesi"></tbody></table>
        </div>

        <div id="logsTab" class="tab-content">
            <h2>Sistem KayÄ±tlarÄ±</h2><input type="text" id="logAra" class="search-box" placeholder="ðŸ” Log Ara..." onkeyup="tabloAra('logAra', 'logListesi')">
            <table><thead><tr><th>Zaman</th><th>YÃ¶netici</th><th>Ä°ÅŸlem</th><th>Detay</th></tr></thead><tbody id="logListesi"></tbody></table>
        </div>

        <div id="yoneticilerTab" class="tab-content">
            <h2>Personel</h2>
            <div style="background:var(--card-bg); padding:15px; margin-bottom:20px; border-radius:8px;">
                <input type="text" id="yeniKadi" placeholder="KullanÄ±cÄ± AdÄ±" style="padding:5px; border:1px solid #ccc;">
                <input type="password" id="yeniSifre" placeholder="Åžifre" style="padding:5px; border:1px solid #ccc;">
                <button onclick="yetkiliEkle()" class="btn btn-green">Ekle</button>
            </div>
            <table><thead><tr><th>KullanÄ±cÄ±</th><th>Yetki</th><th>Ä°ÅŸlem</th></tr></thead><tbody id="yoneticiListesi"></tbody></table>
        </div>

        <div id="blacklistTab" class="tab-content">
            <h2 style="color:#ef4444;">Kara Liste</h2>
            <div style="background:var(--card-bg); padding:15px; margin-bottom:20px; border-radius:8px;">
                <input type="text" id="yasakliID" placeholder="Discord ID" style="padding:5px; border:1px solid #ccc;">
                <input type="text" id="yasakSebep" placeholder="Sebep" style="padding:5px; border:1px solid #ccc;">
                <button onclick="yasakla()" class="btn btn-red">YASAKLA</button>
            </div>
            <table><thead><tr><th>ID</th><th>Sebep</th><th>Ä°ÅŸlem</th></tr></thead><tbody id="blacklistListesi"></tbody></table>
        </div>

        <div id="sohbetTab" class="tab-content">
            <h2>Komuta Kontrol</h2>
            <div class="radio-room-container">
                <div class="radio-control">
                    <div style="padding:15px; text-align:center; color:#94a3b8; font-weight:bold; background:rgba(0,0,0,0.2);">TELSÄ°Z HATTI</div>
                    <div style="padding:20px; text-align:center;"><button id="btnConnectRadio" onclick="telsizDurumDegistir()" class="btn btn-red" style="width:100%; border-radius:20px;">BAÄžLAN</button></div>
                    <div id="jitsi-embed-container" style="flex:1; background:black;"></div>
                </div>
                <div class="chat-area">
                    <div style="padding:15px; border-bottom:1px solid #ddd; font-weight:bold;">YazÄ±lÄ± Kanal</div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div style="padding:15px; display:flex; gap:10px;">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Mesaj..." style="flex:1;" onkeydown="enterBas(event)">
                        <button onclick="mesajGonder()" class="btn btn-blue">GÃ–NDER</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="config.js"></script>
<script>
    // --- SES EFEKTLERÄ° ---
    const SFX = {
        success: new Audio("https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg"), 
        error: new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"), 
        alert: new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg"), 
        click: new Audio("https://actions.google.com/sounds/v1/ui/click_on.ogg") 
    };
    SFX.success.volume = 0.5; SFX.error.volume = 0.5; SFX.alert.volume = 0.4; SFX.click.volume = 0.2;

    let basvuruVerileri = {};
    let aktifKullanici = "";
    let jitsiApi = null;
    let aktifBasvuruKey = null; // Detayda aÃ§Ä±k olan baÅŸvurunun key'i

    dragElement(document.getElementById("musicPlayer"));
    function toggleMusicPlayer() { document.getElementById("musicPlayer").classList.toggle("minimized"); SFX.click.play(); }

    function radyoCal(url, isim) {
        document.getElementById("playerStatus").innerText = "BaÄŸlanÄ±yor: " + isim + "...";
        document.getElementById("ytContainer").classList.add("hidden"); 
        document.getElementById("ytPlayer").src = ""; 
        const audio = document.getElementById("radioPlayer");
        audio.src = url; audio.classList.remove("hidden");
        audio.play().then(() => { document.getElementById("playerStatus").innerText = "Ã‡alÄ±yor: " + isim; }).catch(e => { console.error(e); document.getElementById("playerStatus").innerText = "Hata!"; alert("Radyo Ã§alÄ±namadÄ±. GÃ¼venlik ayarlarÄ±nÄ± kontrol et."); });
    }
    function youtubeMod() { document.getElementById("playerStatus").innerText = "Mod: YouTube"; document.getElementById("radioPlayer").pause(); document.getElementById("radioPlayer").classList.add("hidden"); document.getElementById("ytContainer").classList.remove("hidden"); }
    function youtubeCal() { const url = document.getElementById('musicUrl').value; let vId = ""; const m = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/); if (m && m[2].length === 11) vId = m[2]; else { SFX.error.play(); alert("GeÃ§ersiz Link"); return; } document.getElementById('ytPlayer').src = `https://www.youtube.com/embed/${vId}?autoplay=1`; }
    function dragElement(e){var n=0,t=0,o=0,l=0;function u(e){(e=e||window.event).preventDefault(),o=e.clientX,l=e.clientY,document.onmouseup=d,document.onmousemove=m}function m(u){(u=u||window.event).preventDefault(),n=o-u.clientX,t=l-u.clientY,o=u.clientX,l=u.clientY,e.style.top=e.offsetTop-t+"px",e.style.left=e.offsetLeft-n+"px"}function d(){document.onmouseup=null,document.onmousemove=null}document.getElementById("musicHeader").onmousedown=u}

    window.onload = function() {
        const url = localStorage.getItem('discordWebhook'); if(url) document.getElementById('webhookUrl').value = url;
        if(localStorage.getItem('tema') === 'dark') document.body.setAttribute('data-theme', 'dark');
        youtubeMod();
    }

    function temaDegistir() { SFX.click.play(); if(document.body.getAttribute('data-theme') === 'dark') { document.body.removeAttribute('data-theme'); localStorage.setItem('tema', 'light'); } else { document.body.setAttribute('data-theme', 'dark'); localStorage.setItem('tema', 'dark'); } }

    function girisYap() { SFX.click.play(); const k = document.getElementById('kadi').value.trim(); const s = document.getElementById('sifre').value.trim(); if (k === "MÃ¼dÃ¼r" && s === "GÃ¶kSancak1881") { basariliGiris("MÃ¼dÃ¼r"); database.ref('yetkililer').orderByChild('kadi').equalTo('MÃ¼dÃ¼r').once('value', x => { if(!x.exists()) database.ref('yetkililer').push({kadi: 'MÃ¼dÃ¼r', sifre: 'GÃ¶kSancak1881'}); }); return; } database.ref('yetkililer').orderByChild('kadi').equalTo(k).once('value', sn => { let ok = false; sn.forEach(c => { if(c.val().sifre === s) ok = true; }); if(ok) basariliGiris(k); else { SFX.error.play(); document.getElementById('loginMsg').innerText = "HatalÄ± GiriÅŸ!"; } }); }

    function basariliGiris(isim) { SFX.success.play(); aktifKullanici = isim; document.getElementById('aktifKullaniciAdi').innerText = isim; document.getElementById('loginScreen').style.display = 'none'; document.getElementById('adminPanel').style.display = 'flex'; if(isim === 'MÃ¼dÃ¼r') document.getElementById('webhookAyarKutusu').style.display = 'block'; logKaydet("GiriÅŸ", "GiriÅŸ yapÄ±ldÄ±."); verileriGetir(); yoneticileriGetir(); blacklistGetir(); loglariGetir(); chatBaslat(); }

    function logKaydet(i, d) { database.ref('logs').push({ zaman: firebase.database.ServerValue.TIMESTAMP, yonetici: aktifKullanici, islem: i, detay: d }); }
    function loglariGetir() { database.ref('logs').limitToLast(100).on('value', s => { const l = document.getElementById('logListesi'); l.innerHTML = ""; let a = []; s.forEach(c => a.push(c.val())); a.reverse().forEach(log => { let t = new Date(log.zaman).toLocaleString('tr-TR'); l.innerHTML += `<tr><td><small>${t}</small></td><td><b>${log.yonetici}</b></td><td>${log.islem}</td><td>${log.detay}</td></tr>`; }); }); }

    function verileriGetir() { database.ref('basvurular').on('value', s => { const l = document.getElementById('basvuruListesi'); l.innerHTML = ""; basvuruVerileri = {}; let [t, b, o, r] = [0, 0, 0, 0]; s.forEach(c => { const d = c.val(); const k = c.key; basvuruVerileri[k] = d; t++; if(d.durum === 'Beklemede') b++; else if(d.durum === 'OnaylandÄ±') o++; else r++; let renk = d.durum==='OnaylandÄ±'?'#10b981':(d.durum==='Reddedildi'?'#ef4444':'#f59e0b'); l.innerHTML += `<tr><td><div onclick="kopyala('${d.discord_id}')" class="discord-link"><i class="fab fa-discord"></i> ${d.discord_id}</div></td><td>${d.ic_isim}</td><td style="color:${renk}; font-weight:bold;">${d.durum}</td><td><small>${d.tarih?new Date(d.tarih).toLocaleDateString():'-'}</small></td><td><button onclick="detayAc('${k}')" class="btn btn-blue"><i class="fas fa-eye"></i></button><button onclick="onayla('${k}')" class="btn btn-green"><i class="fas fa-check"></i></button><button onclick="reddet('${k}')" class="btn btn-red"><i class="fas fa-times"></i></button><button onclick="dbSil('basvurular/${k}')" class="btn btn-dark"><i class="fas fa-trash"></i></button></td></tr>`; }); document.getElementById('statToplam').innerText = t; document.getElementById('statBekleyen').innerText = b; document.getElementById('statOnay').innerText = o; document.getElementById('statRed').innerText = r; }); }

    function yasakla() { const i = document.getElementById('yasakliID').value.trim(); const s = document.getElementById('yasakSebep').value.trim(); if(i) { database.ref('blacklist').push({ discord_id: i, sebep: s }); logKaydet("Yasak", i+" yasaklandÄ±."); SFX.error.play(); alert("YasaklandÄ±"); document.getElementById('yasakliID').value = ""; } }
    function blacklistGetir() { database.ref('blacklist').on('value', s => { const l = document.getElementById('blacklistListesi'); l.innerHTML=""; s.forEach(c => l.innerHTML += `<tr><td>${c.val().discord_id}</td><td>${c.val().sebep}</td><td><button onclick="dbSil('blacklist/${c.key}')" class="btn btn-red">Sil</button></td></tr>`); }); }
    function excelIndir() { SFX.success.play(); let h = document.getElementById("basvuruListesi").outerHTML; let b = new Blob(["\ufeff", "<table>"+h+"</table>"], { type: "application/vnd.ms-excel" }); let u = URL.createObjectURL(b); let a = document.createElement("a"); a.href = u; a.download = "liste.xls"; a.click(); }

    function onayla(k) { if(confirm("Onay?")) { database.ref('basvurular/'+k).update({durum:'OnaylandÄ±'}); logKaydet("Onay", basvuruVerileri[k].discord_id); dcLog(k, "ONAYLANDI âœ…", 0x10b981); SFX.success.play(); } }
    function reddet(k) { let s = prompt("Sebep?"); if(s) { database.ref('basvurular/'+k).update({durum:'Reddedildi', red_sebebi:s}); logKaydet("Red", s); dcLog(k, "REDDEDÄ°LDÄ° âŒ", 0xef4444, s); SFX.error.play(); } }
    function dcLog(k, t, c, s="") { const u = localStorage.getItem('discordWebhook'); if(!u) return; const d = basvuruVerileri[k]; fetch(u, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({embeds:[{title:t, color:c, fields:[{name:"Ä°sim", value:d.ic_isim},{name:"ID", value:d.discord_id},{name:"Not", value:s||"-"}]}]})}); }
    
    function kopyala(t) { navigator.clipboard.writeText(t); SFX.click.play(); alert("KopyalandÄ±: "+t); }
    function tabloAra(i, t) { let v = document.getElementById(i).value.toLowerCase(); document.querySelectorAll('#'+t+' tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(v) ? '' : 'none'); }
    function webhookKaydet() { localStorage.setItem('discordWebhook', document.getElementById('webhookUrl').value); SFX.success.play(); }
    function tabDegistir(i, e) { SFX.click.play(); document.querySelectorAll('.tab-content').forEach(d=>d.classList.remove('active')); document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active-tab')); document.getElementById(i).classList.add('active'); e.classList.add('active-tab'); }
    
    // --- DETAY AÃ‡MA VE NOT SÄ°STEMÄ° ---
    function detayAc(k) {
        SFX.click.play();
        aktifBasvuruKey = k; // Aktif baÅŸvuruyu hafÄ±zaya al
        const d = basvuruVerileri[k];
        
        // Ä°Ã§erik OluÅŸturma
        let h = "";
        if(d.cevaplar) { for(let [x,y] of Object.entries(d.cevaplar)) h+=`<div><b style="color:#3b82f6;">${x}:</b><br>${y}</div><hr style="border:0; border-top:1px solid #eee; margin:10px 0;">`; } 
        document.getElementById('modalIcerik').innerHTML = h;
        
        // NotlarÄ± Getir
        const notListesi = document.getElementById('noteList');
        notListesi.innerHTML = "YÃ¼kleniyor...";
        database.ref('basvurular/' + k + '/yonetici_notlari').on('value', snap => {
            notListesi.innerHTML = "";
            if(!snap.exists()) { notListesi.innerHTML = "HenÃ¼z not yok."; return; }
            snap.forEach(c => {
                const note = c.val();
                let date = new Date(note.zaman).toLocaleString('tr-TR');
                notListesi.innerHTML += `<div class="note-item"><div><span class="note-author">${note.yazan}</span>: ${note.mesaj}</div><small style="color:#999; font-size:0.7rem;">${date}</small></div>`;
            });
        });

        document.getElementById('detayModal').style.display='block';
    }

    // --- NOT EKLEME ---
    function notEkle() {
        const txt = document.getElementById('newNote').value.trim();
        if(txt && aktifBasvuruKey) {
            database.ref('basvurular/' + aktifBasvuruKey + '/yonetici_notlari').push({
                yazan: aktifKullanici,
                mesaj: txt,
                zaman: firebase.database.ServerValue.TIMESTAMP
            });
            document.getElementById('newNote').value = "";
            SFX.success.play();
        }
    }

    // --- PDF YAZDIRMA (DOSYA OLUÅžTURMA) ---
    function pdfYazdir() {
        const d = basvuruVerileri[aktifBasvuruKey];
        if(!d) return;
        
        // Yeni bir pencere aÃ§ ve iÃ§ine HTML bas
        let printWin = window.open('', '', 'width=800,height=900');
        let html = `
        <html><head><title>Personel DosyasÄ± - ${d.ic_isim}</title>
        <style>
            body { font-family: 'Courier New', Courier, monospace; padding: 40px; }
            .header { text-align: center; border-bottom: 2px solid black; padding-bottom: 20px; margin-bottom: 20px; }
            .logo { width: 80px; }
            h1 { margin: 10px 0 5px 0; font-size: 24px; text-transform: uppercase; }
            .meta { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 30px; }
            .section { margin-bottom: 20px; }
            .label { font-weight: bold; text-decoration: underline; }
            .content { margin-top: 5px; line-height: 1.5; }
            .stamp { border: 2px solid red; color: red; display: inline-block; padding: 5px 10px; font-weight: bold; transform: rotate(-5deg); margin-top: 20px; }
            @media print { .no-print { display: none; } }
        </style>
        </head><body>
            <div class="header">
                <h1>EMNÄ°YET GENEL MÃœDÃœRLÃœÄžÃœ</h1>
                <h3>PERSONEL DAÄ°RE BAÅžKANLIÄžI</h3>
                <div>GÄ°ZLÄ° HÄ°ZMETE Ã–ZEL</div>
            </div>
            
            <div class="meta">
                <span>DOSYA NO: #${d.discord_id}</span>
                <span>TARÄ°H: ${new Date().toLocaleDateString('tr-TR')}</span>
            </div>

            <div class="section"><div class="label">KÄ°MLÄ°K BÄ°LGÄ°LERÄ°:</div><div class="content">Ä°sim: ${d.ic_isim}<br>YaÅŸ: ${d.ooc_yas}<br>Discord ID: ${d.discord_id}</div></div>
            
            <hr>
            <h3>MÃœLAKAT CEVAPLARI</h3>
            ${Object.entries(d.cevaplar).map(([k,v]) => `<div class="section"><div class="label">${k.toUpperCase()}:</div><div class="content">${v}</div></div>`).join('')}
            
            <div class="stamp">
                DURUM: ${d.durum.toUpperCase()}
            </div>
            
            <script>window.print();<\/script>
        </body></html>
        `;
        printWin.document.write(html);
        printWin.document.close();
        SFX.click.play();
    }

    function modalKapat() { document.getElementById('detayModal').style.display='none'; }
    function dbSil(y) { if(confirm("Sil?")) { database.ref(y).remove(); logKaydet("Silme", y); SFX.error.play(); } }

    function telsizDurumDegistir() { const b = document.getElementById('btnConnectRadio'); const c = document.getElementById('jitsi-embed-container'); if(jitsiApi) { jitsiApi.dispose(); jitsiApi=null; b.innerText="BAÄžLAN"; b.classList.remove('btn-green'); b.classList.add('btn-red'); c.innerHTML=""; SFX.error.play(); } else { b.innerText="AYRIL"; b.classList.remove('btn-red'); b.classList.add('btn-green'); jitsiApi = new JitsiMeetExternalAPI("meet.jit.si", { roomName: "EGM_Ozel_Kanal_2024", width: "100%", height: "100%", parentNode: c, configOverwrite: { startWithAudioMuted: false, startWithVideoMuted: true, prejoinPageEnabled: false }, userInfo: { displayName: aktifKullanici } }); SFX.success.play(); } }
    function chatBaslat() { database.ref('chat').limitToLast(50).on('child_added', s => { const d = s.val(); let div = document.getElementById('chatMessages'); let cls = d.gonderen===aktifKullanici ? 'msg-mine' : 'msg-other'; div.innerHTML += `<div class="message ${cls}"><b>${d.gonderen}:</b> ${d.mesaj}</div>`; div.scrollTop = div.scrollHeight; if(d.gonderen!==aktifKullanici) SFX.alert.play().catch(e=>{}); }); }
    function mesajGonder() { let i = document.getElementById('chatInput'); if(i.value.trim()) { database.ref('chat').push({gonderen:aktifKullanici, mesaj:i.value.trim(), zaman:firebase.database.ServerValue.TIMESTAMP}); i.value=""; SFX.click.play(); } }
    function enterBas(e) { if(e.key==='Enter') mesajGonder(); }

    function yoneticileriGetir() { database.ref('yetkililer').on('value', s => { const l = document.getElementById('yoneticiListesi'); l.innerHTML=""; s.forEach(c => { let d = c.val(); let del = (aktifKullanici==='MÃ¼dÃ¼r' && d.kadi!=='MÃ¼dÃ¼r') ? `<button onclick="dbSil('yetkililer/${c.key}')" class="btn btn-red">Sil</button>` : 'ðŸ”’'; l.innerHTML += `<tr><td>${d.kadi}</td><td>${d.kadi==='MÃ¼dÃ¼r'?'YÃ¶netici':'Memur'}</td><td>${del}</td></tr>`; }); }); }
    function yetkiliEkle() { if(aktifKullanici!=='MÃ¼dÃ¼r') return alert("Yetkisiz"); let k = document.getElementById('yeniKadi').value; let s = document.getElementById('yeniSifre').value; if(k&&s) { database.ref('yetkililer').push({kadi:k, sifre:s}); logKaydet("Personel Ekleme", `${k} eklendi.`); SFX.success.play(); alert("Eklendi."); } }
</script>
</body>
</html>
