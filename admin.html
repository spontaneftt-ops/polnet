<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>EGM Personel YÃ¶netim</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; background: #162447; color: white; display: flex; flex-direction: column; padding: 20px; }
        .content { flex: 1; padding: 40px; overflow-y: auto; background: #eef2f5; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-top: 20px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #1f4068; color: white; }
        
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; margin-right: 5px; font-weight: bold; font-size: 0.9rem; }
        .btn:hover { opacity: 0.8; }
        .btn-green { background: #28a745; } .btn-red { background: #dc3545; } .btn-blue { background: #007bff; } .btn-dark { background: #343a40; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 70%; max-width: 900px; border-radius: 10px; }
        .modal-header { padding: 20px; background-color: #162447; color: white; display: flex; justify-content: space-between; align-items: center; border-radius: 10px 10px 0 0; }
        .modal-body { padding: 30px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 15px; background-color: #eee; text-align: right; border-radius: 0 0 10px 10px; }
        
        .soru-item { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .soru-baslik { font-weight: bold; color: #162447; display: block; margin-bottom: 5px; font-size: 1.1rem; }
        .cevap-metni { color: #333; font-size: 1rem; white-space: pre-wrap; background: #f9f9f9; padding: 10px; border-radius: 5px; border-left: 4px solid #ffd700; }
        
        #loginScreen { position: fixed; top:0; left:0; width:100%; height:100%; background: #162447; z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 10px; width: 350px; text-align: center; }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .menu-item { padding: 15px; cursor: pointer; color: #ccc; } .menu-item:hover, .active-tab { color: white; background: rgba(255,255,255,0.1); border-radius: 5px; }

        /* MÃœDÃœR'E Ã–ZEL WEBHOOK KUTUSU */
        .webhook-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; margin-top: 20px; font-size: 0.8rem; display: none; /* VarsayÄ±lan Gizli */ }
        .webhook-input { width: 100%; padding: 5px; margin-top: 5px; box-sizing: border-box; border: none; border-radius: 3px; }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <h2 style="color:#162447;">YÃ–NETÄ°M PANELÄ°</h2>
        <input type="text" id="kadi" class="login-input" placeholder="KullanÄ±cÄ± AdÄ±">
        <input type="password" id="sifre" class="login-input" placeholder="Åifre">
        <button onclick="girisYap()" class="btn btn-blue" style="width:100%; padding:12px; margin-top:10px;">GiriÅŸ Yap</button>
        <p id="loginMsg" style="color:red; margin-top:10px;"></p>
    </div>
</div>

<div id="detayModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalBaslik" style="margin:0;">BaÅŸvuru DetayÄ±</h2>
            <span onclick="modalKapat()" style="cursor:pointer; font-size:24px;">&times;</span>
        </div>
        <div class="modal-body" id="modalIcerik"></div>
        <div class="modal-footer">
            <button onclick="modalKapat()" class="btn btn-red">Kapat</button>
        </div>
    </div>
</div>

<div id="adminPanel" style="display:none; width:100%;">
    <div class="sidebar">
        <h2 style="color:#ffd700; text-align:center;">MÃœDÃœRLÃœK</h2>
        <div class="menu-item active-tab" onclick="tabDegistir('basvurularTab', this)">ğŸ“„ BaÅŸvurular</div>
        <div class="menu-item" onclick="tabDegistir('yoneticilerTab', this)">ğŸ‘®â€â™‚ï¸ Personel</div>
        
        <div id="webhookAyarKutusu" class="webhook-box">
            <label>Discord Webhook URL:</label>
            <input type="password" id="webhookUrl" class="webhook-input" placeholder="https://discord.com/api/webhooks/..." onchange="webhookKaydet()">
        </div>

        <div class="menu-item" onclick="location.reload()" style="margin-top:auto; color:#e43f5a;">ğŸšª Ã‡Ä±kÄ±ÅŸ</div>
    </div>

    <div class="content">
        <div id="basvurularTab" class="tab-content active">
            <h2 style="color:#162447;">Gelen BaÅŸvurular</h2>
            <table>
                <thead><tr><th>Discord ID</th><th>IC Ä°sim</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead>
                <tbody id="basvuruListesi"></tbody>
            </table>
        </div>

        <div id="yoneticilerTab" class="tab-content">
            <h2 style="color:#162447;">Personel Listesi</h2>
            <div style="background:white; padding:20px; margin-bottom:20px;">
                <input type="text" id="yeniKadi" placeholder="KullanÄ±cÄ± AdÄ±" style="padding:8px;">
                <input type="password" id="yeniSifre" placeholder="Åifre" style="padding:8px;">
                <button onclick="yetkiliEkle()" class="btn btn-green">Ekle</button>
            </div>
            <table>
                <thead><tr><th>KullanÄ±cÄ±</th><th>Åifre</th><th>Ä°ÅŸlem</th></tr></thead>
                <tbody id="yoneticiListesi"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="config.js"></script>
<script>
    const yedekSozluk = {"discord_id": "Discord ID", "ic_isim": "IC Ä°sim Soyisim", "ooc_yas": "OOC YaÅŸ", "aktiflik": "GÃ¼nlÃ¼k Aktiflik", "karakter_hikaye": "Karakter Hikayesi", "deneyim": "FiveM Deneyimi"};
    let basvuruVerileri = {};

    // Sayfa YÃ¼klendiÄŸinde Webhook'u Ã‡ek (Ama henÃ¼z gÃ¶sterme)
    window.onload = function() {
        const kayitliWebhook = localStorage.getItem('discordWebhook');
        if(kayitliWebhook) document.getElementById('webhookUrl').value = kayitliWebhook;
    }

    function webhookKaydet() {
        const url = document.getElementById('webhookUrl').value;
        localStorage.setItem('discordWebhook', url);
    }

    function girisYap() {
        const kadi = document.getElementById('kadi').value.trim();
        const sifre = document.getElementById('sifre').value.trim();
        
        // MÃœDÃœR GÄ°RÄ°ÅÄ° (MASTER KEY)
        if (kadi === "MÃ¼dÃ¼r" && sifre === "GÃ¶kSancak1881") { 
            panelAc(true); // true = MÃ¼dÃ¼r olduÄŸu iÃ§in webhook kutusunu gÃ¶ster
            database.ref('yetkililer').orderByChild('kadi').equalTo('MÃ¼dÃ¼r').once('value', s => { 
                if(!s.exists()) database.ref('yetkililer').push({kadi: 'MÃ¼dÃ¼r', sifre: 'GÃ¶kSancak1881'}); 
            }); 
            return; 
        }

        // NORMAL PERSONEL GÄ°RÄ°ÅÄ°
        database.ref('yetkililer').orderByChild('kadi').equalTo(kadi).once('value', snapshot => { 
            let ok = false; 
            snapshot.forEach(c => { if(c.val().sifre === sifre) ok = true; }); 
            if(ok) {
                // GiriÅŸ yapan kiÅŸi MÃ¼dÃ¼r mÃ¼ veritabanÄ±ndan kontrol et (Ä°sim kontrolÃ¼)
                let isMudur = (kadi === 'MÃ¼dÃ¼r');
                panelAc(isMudur); 
            } else {
                document.getElementById('loginMsg').innerText = "HatalÄ± GiriÅŸ!"; 
            }
        });
    }

    function panelAc(isMudur) { 
        document.getElementById('loginScreen').style.display = 'none'; 
        document.getElementById('adminPanel').style.display = 'flex'; 
        
        // Sadece MÃ¼dÃ¼r ise Webhook kutusunu gÃ¶ster
        if(isMudur) {
            document.getElementById('webhookAyarKutusu').style.display = 'block';
        } else {
            document.getElementById('webhookAyarKutusu').style.display = 'none';
        }

        verileriGetir(); 
        yoneticileriGetir(); 
    }

    function verileriGetir() {
        database.ref('basvurular').on('value', snapshot => {
            const liste = document.getElementById('basvuruListesi'); liste.innerHTML = ""; basvuruVerileri = {};
            if(!snapshot.exists()) { liste.innerHTML = "<tr><td colspan='4'>BaÅŸvuru yok.</td></tr>"; return; }
            snapshot.forEach(child => {
                const data = child.val(); const key = child.key; basvuruVerileri[key] = data;
                let renk = data.durum==='OnaylandÄ±'?'green':(data.durum==='Reddedildi'?'red':'orange');
                let durumYazi = data.durum==='Beklemede'?'DEÄERLENDÄ°RÄ°LÄ°YOR':data.durum;
                
                liste.innerHTML += `
                <tr>
                    <td>${data.discord_id}</td>
                    <td>${data.ic_isim}</td>
                    <td style="color:${renk}; font-weight:bold;">${durumYazi}</td>
                    <td>
                        <button onclick="detayAc('${key}')" class="btn btn-blue">Ä°ncele</button>
                        <button onclick="onayla('${key}')" class="btn btn-green">âœ“</button>
                        <button onclick="reddet('${key}')" class="btn btn-red">âœ—</button>
                        <button onclick="dbSil('basvurular/${key}')" class="btn btn-dark">ğŸ—‘ï¸</button>
                    </td>
                </tr>`;
            });
        });
    }

    function onayla(key) {
        if(confirm("BaÅŸvuruyu onaylamak istiyor musun?")) {
            database.ref('basvurular/'+key).update({durum: 'OnaylandÄ±'});
            discordLogGonder(key, "ONAYLANDI âœ…", 0x28a745);
        }
    }

    function reddet(key) {
        let sebep = prompt("Reddetme sebebini yazÄ±nÄ±z:", "Yetersiz baÅŸvuru / Kurallara uygun deÄŸil");
        if(sebep) {
            database.ref('basvurular/'+key).update({ durum: 'Reddedildi', red_sebebi: sebep });
            discordLogGonder(key, "REDDEDÄ°LDÄ° âŒ", 0xdc3545, sebep);
        }
    }

    function discordLogGonder(key, durumMetni, renk, sebep = "") {
        const url = localStorage.getItem('discordWebhook');
        if(!url) return; // Webhook yoksa gÃ¶nderme
        
        const data = basvuruVerileri[key];
        
        let fields = [
            { name: "ğŸ‘¤ IC Ä°sim", value: data.ic_isim, inline: true },
            { name: "ğŸ†” Discord ID", value: `<@${data.discord_id}> (${data.discord_id})`, inline: true },
            { name: "ğŸ‚ OOC YaÅŸ", value: data.ooc_yas, inline: true }
        ];

        if(sebep) fields.push({ name: "ğŸ“ Red Sebebi", value: sebep });

        const payload = {
            embeds: [{
                title: `BaÅŸvuru Durumu: ${durumMetni}`,
                color: renk,
                fields: fields,
                footer: { text: "EGM YÃ¶netim Paneli" },
                timestamp: new Date()
            }]
        };

        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).catch(err => console.error(err));
    }

    function detayAc(key) {
        const data = basvuruVerileri[key]; document.getElementById('modalBaslik').innerText = `${data.ic_isim} - Detay`; let html = "";
        if(data.cevaplar) {
            for (const [id, val] of Object.entries(data.cevaplar)) {
                let txt = (data.soru_detaylari && data.soru_detaylari[id]) ? data.soru_detaylari[id] : (yedekSozluk[id] || id);
                html += `<div class="soru-item"><span class="soru-baslik">${txt}</span><div class="cevap-metni">${val}</div></div>`;
            }
        } else { html = "<p>Veri yok.</p>"; }
        if(data.red_sebebi) html += `<div style="margin-top:20px; border:2px solid red; padding:10px; border-radius:5px;"><strong style="color:red">RED SEBEBÄ°:</strong> ${data.red_sebebi}</div>`;
        document.getElementById('modalIcerik').innerHTML = html; document.getElementById('detayModal').style.display = "block";
    }
    function modalKapat() { document.getElementById('detayModal').style.display = "none"; }
    function yoneticileriGetir() { database.ref('yetkililer').on('value', s => { const l = document.getElementById('yoneticiListesi'); l.innerHTML = ""; s.forEach(c => { let sil = c.val().kadi === 'MÃ¼dÃ¼r' ? 'ğŸ”’' : `<button onclick="dbSil('yetkililer/${c.key}')" class="btn btn-red">Sil</button>`; l.innerHTML += `<tr><td>${c.val().kadi}</td><td>â€¢â€¢â€¢â€¢</td><td>${sil}</td></tr>`; }); }); }
    function yetkiliEkle() { const k=document.getElementById('yeniKadi').value.trim(), s=document.getElementById('yeniSifre').value.trim(); if(k&&s) { database.ref('yetkililer').push({kadi:k, sifre:s}); alert("Eklendi."); } }
    function dbSil(y) { if(confirm('Silinsin mi?')) database.ref(y).remove(); }
    function tabDegistir(id, el) { document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active')); document.getElementById(id).classList.add('active'); }
</script>
</body>
</html>
